let v=!1;document.addEventListener("DOMContentLoaded",function(){k(),w(),_()});function k(){const e=document.getElementById("addInsuranceBtn");e&&e.addEventListener("click",E);const t=document.getElementById("addInsuranceEmptyBtn");t&&t.addEventListener("click",E);const i=document.getElementById("loadInsuranceDataBtn");i&&i.addEventListener("click",z),document.querySelectorAll(".toggle-btn").forEach(d=>{d.addEventListener("click",function(){document.querySelectorAll(".toggle-btn").forEach(p=>p.classList.remove("active")),this.classList.add("active");const s=this.getAttribute("data-view"),l=document.getElementById("policiesGrid");l&&(l.classList.remove("grid-view","list-view"),s==="grid"?l.classList.add("grid-view"):s==="list"&&l.classList.add("list-view"))})});const a=document.getElementById("statusFilter");a&&a.addEventListener("change",function(){A(this.value)});const n=document.getElementById("insuranceForm");n&&n.addEventListener("submit",function(d){d.preventDefault();const s=document.getElementById("insuranceSubmitBtn");s&&s.disabled||(s&&(s.disabled=!0,s.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...'),G(d))});const c=document.getElementById("modal-registration_date");c&&c.addEventListener("change",function(){const d=this.value;if(!d)return;const s=new Date(d);s.setFullYear(s.getFullYear()+1);const l=document.getElementById("modal-expiration_date");l&&(l.value=s.toISOString().slice(0,10))})}function w(){fetch(insuranceDataUrl).then(e=>e.json()).then(e=>{O(e.data)}).catch(e=>{console.error("Error loading insurance data:",e),M("Error","Failed to load insurance data","error")})}function O(e){const t=document.getElementById("policiesGrid");if(!t)return;if(t.querySelectorAll(".policy-card").forEach(n=>n.remove()),!e||e.length===0){if(!t.querySelector(".empty-state")){const n=document.createElement("div");n.className="empty-state",n.innerHTML=`
                <div class="empty-icon">
                    <i class="fas fa-file-contract"></i>
                </div>
                <h3>No Insurance Policies Found</h3>
                <p>Get started by adding your first insurance policy</p>
                <button class="action-btn view" id="addInsuranceEmptyBtn">
                    <i class="fas fa-plus-circle"></i>
                    Add New Insurance
                </button>
            `,t.appendChild(n);const c=document.getElementById("addInsuranceEmptyBtn");c&&c.addEventListener("click",E)}return}const a=t.querySelector(".empty-state");a&&a.remove(),e.forEach(n=>{const c=F(n),d=L(n,c);t.appendChild(d)})}function L(e,t){const i=document.createElement("div");i.className="policy-card",i.setAttribute("data-status",t),i.setAttribute("data-id",e.id);const a=x(e.code),n=`${e.client_name||"N/A"}`,c=e.category_name||"Unknown Category",d=window.userId===1&&window.userOfficeId===0,s=e.office_name||"N/A",l=d?`
        <div class="detail-row">
            <span class="detail-label">Office:</span>
            <span class="detail-value">${s}</span>
        </div>
    `:"";return i.innerHTML=`
        <div class="card-header">
            <div class="policy-meta">
                <span class="policy-id">${e.mvfile_no||e.code||"N/A"}</span>
                <span class="policy-date">${D(e.registration_date)}</span>
            </div>
            <div class="status-badge ${t}">
                ${P(t)}
            </div>
        </div>
        
        <div class="card-body">
            <div class="client-info">
                <h3 class="client-name">${n}</h3>
                <div class="client-details">
                    <div class="detail-row">
                        <span class="detail-label">Category:</span>
                        <span class="detail-value">${c}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Plate No:</span>
                        <span class="detail-value">${e.registration_no||"N/A"}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">COC No:</span>
                        <span class="detail-value">${e.coc_no||"N/A"}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Engine No:</span>
                        <span class="detail-value">${e.engine_no||"N/A"}</span>
                    </div>
                    ${l}
                </div>
            </div>
            
            <div class="policy-type-indicator" style="--policy-color: ${a}">
                <span class="policy-type">${e.policy_name||"Standard"}</span>
            </div>
        </div>
        
        <div class="card-footer">
            <div class="action-buttons">
                <button class="action-btn-small view" onclick="viewInsuranceDetails(${e.id})">
                    <i class="fas fa-eye"></i> View
                </button>
                ${window.userPermissions>0?`<button class="action-btn-small edit" onclick="editInsuranceDetails(${e.id})">
                    <i class="fas fa-edit"></i> Edit
                </button>`:""}
                ${window.userPermissions===1?`<button class="action-btn-small delete" onclick="deleteInsurance(${e.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>`:""}
            </div>
        </div>
    `,i}function F(e){return e.expiration_date&&new Date(e.expiration_date)<new Date?"expired":e.status===1?"active":"pending"}function P(e){return{active:"Active",pending:"Pending",expired:"Expired"}[e]||"Pending"}function x(e){const t={liberty:"#FF6B6B",milestone:"#4ECDC4",pacific:"#45B7D1",stronghold:"#FFA07A"};if(!e)return"#6c757d";const i=e.toLowerCase();for(const[a,n]of Object.entries(t))if(i.includes(a))return n;return"#6c757d"}function D(e){if(!e)return"N/A";try{return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return e}}function A(e){const t=document.querySelectorAll(".policy-card");let i=0;t.forEach(a=>{const n=a.getAttribute("data-status");e==="all"||n===e?(a.style.display="flex",i++):a.style.display="none"}),q(i,e)}function q(e,t){const i=document.getElementById("policiesGrid");if(!i)return;const a=i.querySelector(".empty-state");if(e===0&&!a){const n=document.createElement("div");n.className="empty-state",n.innerHTML=`
            <div class="empty-icon">
                <i class="fas fa-search"></i>
            </div>
            <h3>No ${t==="all"?"":t+" "}Policies Found</h3>
            <p>No policies match the selected filter criteria</p>
        `,i.appendChild(n)}else e>0&&a&&a.remove()}function _(){const e={activeCount:0,pendingCount:0,expiredCount:0,totalCount:0};fetch(insuranceDataUrl).then(t=>t.json()).then(t=>{(t.data||[]).forEach(a=>{if(e.totalCount++,a.expiration_date&&new Date(a.expiration_date)<new Date){e.expiredCount++;return}a.status===1?e.activeCount++:e.pendingCount++}),j(e)}).catch(t=>console.error("Error loading statistics:",t))}function j(e){const t={activeCount:document.getElementById("activeCount"),pendingCount:document.getElementById("pendingCount"),expiredCount:document.getElementById("expiredCount"),totalCount:document.getElementById("totalCount")};for(const[i,a]of Object.entries(t))a&&(a.textContent=e[i]||0)}async function E(){g(1);const e=await H();if(!e){g(0);return}const{cocNumber:t,orNumber:i,policyNumber:a}=e;g(2);const n=await U();if(!n){g(0);return}if(g(3),n.isCopy&&n.existingRecord){V(n.existingRecord,e,n);return}if(!n.existingRecord){X(e,n);return}g(4),S({mvfile_no:n.mvfile_no,coc_no:t,or_no:i||t,policy_no:a||t},n.existingRecord||null,n.isCopy||!1,null)}async function H(){return new Promise(e=>{const t=document.createElement("div");t.className="modern-input-container",t.innerHTML=`
            <div class="input-header">
                <i class="fas fa-id-card"></i>
                <h3>Enter COC Number</h3>
            </div>
            <div class="tutorial-tip-box">
                <i class="fas fa-lightbulb"></i>
                <span><strong>Tip:</strong> COC (Certificate of Cover) is an 8-digit number found on your insurance certificate.</span>
            </div>
            <div class="input-wrapper">
                <input type="text" id="coc-input" class="modern-input" placeholder="12345678" maxlength="8" data-tutorial="coc-input">
                <div class="status-indicator" id="coc-status-indicator"></div>
            </div>
            <div class="status-message" id="coc-status-message"></div>
            <div id="additional-fields" class="additional-fields" style="display: none;">
                <div class="input-header">
                    <i class="fas fa-info-circle"></i>
                    <h3>Additional Information</h3>
                </div>
                <div class="tutorial-tip-box secondary">
                    <i class="fas fa-info-circle"></i>
                    <span>These fields are optional but help with record keeping.</span>
                </div>
                <div class="input-wrapper">
                    <input type="text" id="or-number" class="modern-input" placeholder="OR Number" data-tutorial="or-input">
                </div>
                <div class="input-wrapper">
                    <input type="text" id="policy-number" class="modern-input" placeholder="Policy Number" data-tutorial="policy-input">
                </div>
            </div>
        `,Swal.fire({title:"",html:t,showCancelButton:!0,confirmButtonText:"Continue",cancelButtonText:"Cancel",customClass:{popup:"modern-swal-popup tutorial-swal-popup",confirmButton:"modern-confirm-btn",cancelButton:"modern-cancel-btn"},didOpen:()=>{const i=document.getElementById("coc-input"),a=document.getElementById("coc-status-indicator"),n=document.getElementById("coc-status-message"),c=document.getElementById("additional-fields");i.addEventListener("input",async function(){const d=this.value.trim();if(!d){a.className="status-indicator",n.textContent="",c.style.display="none";return}if(!/^[0-9]{8}$/.test(d)){a.className="status-indicator invalid",n.textContent="Invalid format. Use 8 digits only",n.className="status-message error",c.style.display="none";return}a.className="status-indicator checking",n.textContent="Validating COC number...",n.className="status-message checking",c.style.display="none";try{const l=await(await fetch(insuranceValidateCocUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({coc_no:d})})).json();l.valid?(a.className="status-indicator valid",n.textContent="",c.style.display="block"):(a.className="status-indicator invalid",n.textContent=l.message||"COC number is invalid",n.className="status-message error",c.style.display="none")}catch(s){a.className="status-indicator error",n.textContent="Error validating COC number",n.className="status-message error",console.error(s)}})},preConfirm:()=>{var s,l;const a=document.getElementById("coc-input").value.trim();if(!a)return Swal.showValidationMessage("COC number is required!"),!1;if(!/^[0-9]{8}$/.test(a))return Swal.showValidationMessage("Invalid format. Use 8 digits only"),!1;if(!document.getElementById("coc-status-indicator").classList.contains("valid"))return Swal.showValidationMessage("Please fix COC number validation issues first"),!1;const c=((s=document.getElementById("or-number"))==null?void 0:s.value.trim())||"",d=((l=document.getElementById("policy-number"))==null?void 0:l.value.trim())||"";return{cocNumber:a,orNumber:c,policyNumber:d}}}).then(i=>{i.isConfirmed?e(i.value):e(null)})})}async function U(){let e=null,t=!1,i=!1;return new Promise(a=>{const n=document.createElement("div");n.className="modern-input-container",n.innerHTML=`
            <div class="input-header">
                <i class="fas fa-car"></i>
                <h3>Bind MV File Number</h3>
            </div>
            <div class="tutorial-tip-box">
                <i class="fas fa-lightbulb"></i>
                <span><strong>Tip:</strong> MV File Number links this insurance to a specific vehicle. If the vehicle exists in another office, you can copy its data.</span>
            </div>
            <div class="input-wrapper">
                <input type="text" id="mvfile-input" class="modern-input" placeholder="Enter MV File Number" data-tutorial="mvfile-input">
                <div class="status-indicator" id="status-indicator"></div>
            </div>
            <div class="status-message" id="status-message"></div>
            <div class="record-details" id="record-details" style="display: none;"></div>
        `,Swal.fire({title:"",html:n,showCancelButton:!0,confirmButtonText:"Bind & Continue",cancelButtonText:"Cancel",customClass:{popup:"modern-swal-popup tutorial-swal-popup",confirmButton:"modern-confirm-btn",cancelButton:"modern-cancel-btn"},didOpen:()=>{const c=document.getElementById("mvfile-input"),d=document.getElementById("status-indicator"),s=document.getElementById("status-message"),l=document.getElementById("record-details");c.addEventListener("input",async function(){var m;const p=this.value.trim();if(!p){d.className="status-indicator",s.textContent="",l.style.display="none",e=null,t=!1,i=!0;return}d.className="status-indicator checking",s.textContent="Checking MV File availability...",s.className="status-message checking",l.style.display="none",e=null,t=!1,i=!1;try{const r=await(await fetch(insuranceValidateMvFileUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({mvfile_no:p})})).json();i=!0,r.exists?r.sameOffice?(d.className="status-indicator valid",s.textContent="MV File found in your office records - you can edit this record",s.className="status-message valid",e=r.record,t=!1,l.innerHTML=N(r.record,!1),l.style.display="block"):(d.className="status-indicator valid",s.textContent=`MV File found in ${((m=r.record)==null?void 0:m.source_office_name)||"another office"} - you can copy this data to your office`,s.className="status-message valid",e=r.record,t=!0,l.innerHTML=N(r.record,!0),l.style.display="block"):(d.className="status-indicator invalid",s.textContent="MV File not found - will create new record",s.className="status-message warning",l.style.display="none",e=null,t=!1)}catch(u){i=!0,d.className="status-indicator error",s.textContent="Error checking MV File",s.className="status-message error",console.error(u)}})},preConfirm:async()=>{const d=document.getElementById("mvfile-input").value.trim();if(!d)return Swal.showValidationMessage("MV File number is required!"),!1;if(!i){statusIndicator.className="status-indicator checking",statusMessage.textContent="Validating...";try{const l=await(await fetch(insuranceValidateMvFileUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({mvfile_no:d})})).json();l.exists?(e=l.record,t=!l.sameOffice):(e=null,t=!1)}catch(s){console.error("Validation error:",s)}}return{mvfile_no:d,existingRecord:e,isCopy:t}}}).then(c=>{c.isConfirmed?a(c.value):a(null)})})}function N(e){return`
        <div class="record-card">
            <div class="record-header">
                <i class="fas fa-file-contract"></i>
                <h4>Existing Insurance Record</h4>
                <span class="verified-badge">Verified</span>
            </div>
            <div class="record-body">
                <div class="record-field">
                    <label>Policy Number:</label>
                    <span>${e.policy_no?"#"+e.policy_no:"N/A"}</span>
                </div>
                <div class="record-field">
                    <label>COC Number:</label>
                    <span>${e.coc_no||"N/A"}</span>
                </div>
                <div class="record-field">
                    <label>OR Number:</label>
                    <span>${e.or_no||"N/A"}</span>
                </div>
            </div>
        </div>
    `}let b=null,C=null;function V(e,t,i){const a=document.getElementById("clientEditModal"),n=document.getElementById("clientEditModalOverlay"),c=document.getElementById("clientEditForm");if(!a||!c)return;C=t,b=i,document.getElementById("edit-client-original-id").value=e.client_id||"",document.getElementById("edit-firstname").value=e.firstname||"",document.getElementById("edit-middlename").value=e.middlename||"",document.getElementById("edit-lastname").value=e.lastname||"",document.getElementById("edit-email").value=e.email||"",document.getElementById("edit-contact").value=e.contact||"",document.getElementById("edit-dob").value=e.dob||"",document.getElementById("edit-markup").value=e.markup||"",document.getElementById("edit-address").value=e.address||"";const d=`${e.firstname||""} ${e.middlename?e.middlename+" ":""}${e.lastname||""}`;document.getElementById("originalClientName").textContent=`Original: ${d}`,a.style.display="flex",n&&(n.style.display="block")}window.closeClientEditModal=function(){const e=document.getElementById("clientEditModal"),t=document.getElementById("clientEditModalOverlay");e&&(e.style.display="none"),t&&(t.style.display="none"),C=null,b=null};window.submitClientEdit=function(){if(v)return;v=!0;const e=document.getElementById("editClientSubmitBtn");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Updating...'),document.getElementById("clientEditForm");const t=document.getElementById("edit-firstname").value.trim(),i=document.getElementById("edit-lastname").value.trim();if(!t){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Update Client'),v=!1,Swal.fire({icon:"error",title:"Validation Error",text:"First name is required!"});return}if(!i){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Update Client'),v=!1,Swal.fire({icon:"error",title:"Validation Error",text:"Last name is required!"});return}const a={firstname:t,middlename:document.getElementById("edit-middlename").value.trim(),lastname:i,email:document.getElementById("edit-email").value.trim(),contact:document.getElementById("edit-contact").value.trim(),dob:document.getElementById("edit-dob").value,markup:document.getElementById("edit-markup").value.trim(),address:document.getElementById("edit-address").value.trim()},n=b,c=C;closeClientEditModal(),n&&c&&(g(4),S({mvfile_no:n.mvfile_no,coc_no:c.cocNumber,or_no:c.orNumber||c.cocNumber,policy_no:c.policyNumber||c.cocNumber},n.existingRecord||null,n.isCopy||!1,a)),v=!1};let I=null,B=null;function X(e,t){const i=document.getElementById("createClientModal"),a=document.getElementById("createClientModalOverlay"),n=document.getElementById("createClientForm");!i||!n||(I=e,B=t,n.reset(),i.style.display="flex",a&&(a.style.display="block"))}window.closeCreateClientModal=function(){const e=document.getElementById("createClientModal"),t=document.getElementById("createClientModalOverlay");e&&(e.style.display="none"),t&&(t.style.display="none"),I=null,B=null};window.submitCreateClient=async function(){if(v)return;v=!0;const e=document.getElementById("createClientSubmitBtn");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Creating...');const t=document.getElementById("create-firstname").value.trim(),i=document.getElementById("create-lastname").value.trim();if(!t){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Create Client'),Swal.fire({icon:"error",title:"Validation Error",text:"First name is required!"});return}if(!i){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Create Client'),Swal.fire({icon:"error",title:"Validation Error",text:"Last name is required!"});return}const a={firstname:t,middlename:document.getElementById("create-middlename").value.trim(),lastname:i,email:document.getElementById("create-email").value.trim(),contact:document.getElementById("create-contact").value.trim(),dob:document.getElementById("create-dob").value,walkin_list:document.getElementById("create-markup").value.trim()||"Walk-in",address:document.getElementById("create-address").value.trim()||"N/A",status:"1"};Swal.fire({title:"Creating Client...",allowOutsideClick:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}});try{const n=document.querySelector('meta[name="csrf-token"]').content,c=await fetch("/clients",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":n,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(a)}),d=await c.json();if(!c.ok)throw new Error(d.message||"Failed to create client");const s=d.data,l=s.id,p=`${s.lastname}, ${s.firstname}${s.middlename?" "+s.middlename:""}`;console.log("Client created successfully:",l,p);const m=B,u=I;console.log("Stored results:",{localMvfileResult:m,localCocResult:u}),closeCreateClientModal(),Swal.close(),setTimeout(()=>{if(m&&u){console.log("Opening insurance form with new client:",l),g(4);const r=$("#modal-client_id"),y=new Option(p,l,!0,!0);r.append(y),S({mvfile_no:m.mvfile_no,coc_no:u.cocNumber,or_no:u.orNumber||u.cocNumber,policy_no:u.policyNumber||u.cocNumber},null,!1,null,l)}else console.error("Missing required data:",{localMvfileResult:m,localCocResult:u}),Swal.fire({icon:"error",title:"Error",text:"Failed to open insurance form. Missing required data."});v=!1},300)}catch(n){console.error("Error creating client:",n),Swal.fire({icon:"error",title:"Error",text:n.message||"Failed to create client. Please try again."})}finally{e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Create Client'),v=!1}};async function S(e,t,i=!1,a=null,n=null){console.log("showManageInsuranceModal called with:",{formData:e,existingRecord:t,isCopy:i,editedClientData:a,newClientId:n});const c=document.getElementById("manageInsuranceModal"),d=document.getElementById("insuranceModalOverlay"),s=document.getElementById("insuranceForm"),l=document.getElementById("insuranceSubmitBtn"),p=document.getElementById("manageInsuranceModalTitle"),m=document.getElementById("officeSelectGroup");if(console.log("Modal elements found:",{modal:!!c,overlay:!!d,form:!!s,submitBtn:!!l,modalTitle:!!p}),!c||!s){console.error("Modal or form not found! Cannot open insurance form.");return}if(document.getElementById("insurance_id").value="",document.getElementById("insurance_form_method").value="POST",o("modal-mvfile_no",e.mvfile_no||""),o("modal-coc_no",e.coc_no||""),o("modal-or_no",e.or_no||""),o("modal-policy_no",e.policy_no||""),t)if(i){document.getElementById("insurance_id").value="",document.getElementById("insurance_form_method").value="POST",p.textContent="Copy Insurance Record to Your Office",l.innerHTML='<i class="fas fa-copy"></i> Create Copy in Your Office',o("modal-client_id","clone_"+t.client_id),o("modal-policy_id",t.policy_id||"");let u=document.getElementById("modal-clone_client_id");if(u||(u=document.createElement("input"),u.type="hidden",u.id="modal-clone_client_id",s.appendChild(u)),u.value=t.client_id,a){let r=document.getElementById("modal-edited_client_data");r||(r=document.createElement("input"),r.type="hidden",r.id="modal-edited_client_data",r.name="edited_client_data",s.appendChild(r)),r.value=JSON.stringify(a)}if(o("modal-category_id",t.auth_no||""),o("modal-code",""),o("modal-registration_no",t.registration_no||""),o("modal-chassis_no",t.chassis_no||""),o("modal-engine_no",t.engine_no||""),o("modal-vehicle_model",t.vehicle_model||""),o("modal-vehicle_color",t.vehicle_color||""),o("modal-make",t.make||""),o("modal-registration_date",""),o("modal-expiration_date",""),o("modal-cost",""),o("modal-status","0"),o("modal-remarks",t.insurance_remarks||t.remarks||""),setTimeout(()=>{const r=a?a.firstname+" "+(a.middlename?a.middlename+" ":"")+a.lastname+" (Edited - Will be cloned to your office)":t.firstname+" "+(t.middlename?t.middlename+" ":"")+t.lastname+" (Will be cloned to your office)",y=$("#modal-client_id"),f=new Option(r,"clone_"+t.client_id,!0,!0);y.append(f).trigger("change"),t.policy_id&&$("#modal-policy_id").val(t.policy_id).trigger("change"),t.auth_no&&$("#modal-category_id").val(t.auth_no).trigger("change")},100),m&&window.isSuperAdmin){m.style.display="block";const r=document.getElementById("modal-office_id");r&&(r.value="")}else m&&(m.style.display="none")}else document.getElementById("insurance_id").value=t.insurance_id||"",document.getElementById("insurance_form_method").value="PUT",o("modal-client_id",t.client_id||""),o("modal-policy_id",t.policy_id||""),o("modal-category_id",t.auth_no||""),o("modal-code",t.insurance_code||t.code||""),o("modal-registration_no",t.registration_no||""),o("modal-chassis_no",t.chassis_no||""),o("modal-engine_no",t.engine_no||""),o("modal-vehicle_model",t.vehicle_model||""),o("modal-vehicle_color",t.vehicle_color||""),o("modal-make",t.make||""),o("modal-registration_date",t.registration_date||""),o("modal-expiration_date",t.expiration_date||""),o("modal-cost",t.cost??""),o("modal-status",String(t.insurance_status??t.status??"0")),o("modal-remarks",t.insurance_remarks||t.remarks||""),p.textContent="Edit Insurance",l.innerHTML='<i class="fas fa-save"></i> Update',setTimeout(()=>{t.client_id&&$("#modal-client_id").val(t.client_id).trigger("change"),t.policy_id&&$("#modal-policy_id").val(t.policy_id).trigger("change"),t.auth_no&&$("#modal-category_id").val(t.auth_no).trigger("change")},100),m&&(m.style.display="none");else if(n?o("modal-client_id",n):o("modal-client_id",""),o("modal-policy_id",""),o("modal-category_id",""),o("modal-registration_no",""),o("modal-chassis_no",""),o("modal-engine_no",""),o("modal-vehicle_model",""),o("modal-vehicle_color",""),o("modal-make",""),o("modal-registration_date",""),o("modal-expiration_date",""),o("modal-cost",""),o("modal-status","0"),o("modal-remarks",""),p.textContent="New Insurance",l.innerHTML='<i class="fas fa-save"></i> Save',setTimeout(()=>{n?$("#modal-client_id").val(n).trigger("change"):$("#modal-client_id").val("").trigger("change"),$("#modal-policy_id").val("").trigger("change"),$("#modal-category_id").val("").trigger("change")},100),m&&window.isSuperAdmin){m.style.display="block";const u=document.getElementById("modal-office_id");u&&(u.value="")}else m&&(m.style.display="none");c.style.setProperty("display","flex","important"),c.style.setProperty("visibility","visible","important"),c.style.setProperty("opacity","1","important"),c.style.setProperty("z-index","9999","important"),d&&(d.style.setProperty("display","block","important"),d.style.setProperty("visibility","visible","important"),d.style.setProperty("opacity","1","important"),d.style.setProperty("z-index","9998","important")),console.log("Modal display styles set:",{modalDisplay:c.style.display,modalVisibility:c.style.visibility,modalOpacity:c.style.opacity,modalZIndex:c.style.zIndex}),setTimeout(()=>{$(".js-example-basic-single").select2({width:"100%",dropdownParent:$("#manageInsuranceModal")}),(c.style.display==="none"||window.getComputedStyle(c).display==="none")&&(console.warn("Modal was hidden after Select2 init, forcing visible again"),c.style.setProperty("display","flex","important"))},200)}function o(e,t){const i=document.getElementById(e);if(!i)return;const a=t==null?"":String(t);i.classList.contains("js-example-basic-single"),i.value=a}window.closeInsuranceModal=function(){const e=document.getElementById("manageInsuranceModal"),t=document.getElementById("insuranceModalOverlay");e&&(e.style.display="none"),t&&(t.style.display="none")};async function G(e){var u;e.preventDefault();const t=document.getElementById("insuranceForm"),i=document.getElementById("insuranceSubmitBtn");if(!t)return;const a=document.getElementById("insurance_id").value,n=!!a,c=new FormData(t),d={};c.forEach((r,y)=>{y==="_token"||y==="_method"||y==="insurance_id"||(d[y]=r)});const s=document.getElementById("modal-edited_client_data");if(s&&s.value)try{d.edited_client_data=JSON.parse(s.value)}catch(r){console.error("Error parsing edited client data:",r)}if(!n&&window.isSuperAdmin){const r=(u=document.getElementById("modal-office_id"))==null?void 0:u.value;r&&(d.office_id=r)}const l=n?`${insuranceUpdateUrl}/${a}`:insuranceStoreUrl,p=n?"PUT":"POST",m=document.querySelector('meta[name="csrf-token"]').content;i&&(i.disabled=!0,i.innerHTML='<i class="fas fa-spinner fa-spin"></i> '+(n?"Updating...":"Saving..."));try{const r={method:p,headers:{"Content-Type":"application/json","X-CSRF-TOKEN":m,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(d)};p==="PUT"&&(r.headers["X-HTTP-Method-Override"]="PUT");const y=await fetch(l,r),f=await y.json().catch(()=>({}));if(!y.ok){if(y.status===422&&f&&f.message)throw closeInsuranceModal(),new Error(f.message);const T=f&&typeof f=="object"&&f.errors&&typeof f.errors=="object"?Object.values(f.errors).flat().filter(Boolean).join(" "):f&&typeof f=="object"&&f.message||"Request failed";throw new Error(T)}w(),_();let h=a;!h&&f&&f.insurance&&f.insurance.id&&(h=f.insurance.id),closeInsuranceModal(),Swal.fire({title:"Success!",text:n?"Insurance record updated successfully!":"Insurance record added successfully!",icon:"success",timer:2e3,showConfirmButton:!1}).then(()=>{h&&(window.location.href=`/insurances/${h}`)})}catch(r){typeof Swal<"u"?Swal.fire({icon:"error",title:"Error",text:r.message||"Something went wrong."}):alert(r.message||"Something went wrong.")}finally{i&&(i.disabled=!1,i.innerHTML=n?'<i class="fas fa-save"></i> Update':'<i class="fas fa-save"></i> Save'),v=!1}}function J(e){window.location.href=`/insurances/${e}`}function z(){Swal.fire({title:"Load Data",input:"select",inputOptions:{10:"Load 10 Records",50:"Load 50 Records",100:"Load 100 Records",500:"Load 500 Records"},inputPlaceholder:"Select batch size",showCancelButton:!0,confirmButtonText:"Load",customClass:{popup:"modern-swal-popup",confirmButton:"modern-confirm-btn",cancelButton:"modern-cancel-btn"}}).then(e=>{e.isConfirmed&&K(e.value)})}function K(e){Swal.fire({title:"Loading Data...",html:'<div style="width: 100%; background: #f3f3f3; border-radius: 25px; overflow: hidden;"><div id="data-progress" style="width: 0%; height: 20px; background: linear-gradient(90deg, #1877f2, #7209b7);"></div></div>',allowOutsideClick:!1,showConfirmButton:!1,didOpen:()=>{let t=0;const i=setInterval(()=>{t+=5;const a=document.getElementById("data-progress");a&&(a.style.width=t+"%"),t>=100&&clearInterval(i)},100);setTimeout(()=>{w(),Swal.close(),M("Success","Data loaded successfully","success")},2e3)}})}function g(e){document.querySelectorAll(".flow-step").forEach(t=>{t.classList.remove("active"),parseInt(t.getAttribute("data-step"))<=e&&t.classList.add("active")})}function M(e,t,i){Swal.fire({title:e,text:t,icon:i,customClass:{popup:"modern-swal-popup",confirmButton:"modern-confirm-btn"}})}window.viewInsuranceDetails=function(e){window.location.href=`/insurances/${e}`};window.editInsuranceDetails=function(e){W(e)};function W(e){const t=document.getElementById("manageInsuranceModal"),i=document.getElementById("insuranceModalOverlay"),a=document.getElementById("insuranceForm"),n=document.getElementById("insuranceSubmitBtn"),c=document.getElementById("manageInsuranceModalTitle"),d=document.getElementById("officeSelectGroup");!t||!a||(n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Loading...',fetch(`${manageInsuranceUrl}?id=${e}`).then(s=>s.json()).then(s=>{if(!s.insurance)throw new Error("Insurance not found");const l=s.insurance;document.getElementById("insurance_id").value=l.id,document.getElementById("insurance_form_method").value="PUT",o("modal-mvfile_no",l.mvfile_no||""),o("modal-coc_no",l.coc_no||""),o("modal-or_no",l.or_no||""),o("modal-policy_no",l.policy_no||""),o("modal-registration_no",l.registration_no||""),o("modal-chassis_no",l.chassis_no||""),o("modal-engine_no",l.engine_no||""),o("modal-vehicle_model",l.vehicle_model||""),o("modal-vehicle_color",l.vehicle_color||""),o("modal-make",l.make||""),o("modal-registration_date",l.registration_date||""),o("modal-expiration_date",l.expiration_date||""),o("modal-cost",l.cost||""),o("modal-status",String(l.status||"0")),o("modal-remarks",l.remarks||""),c.textContent="Edit Insurance",n.innerHTML='<i class="fas fa-save"></i> Update',n.disabled=!1,n.onclick=null,a.querySelectorAll(".form-control").forEach(m=>{m.removeAttribute("readonly"),m.removeAttribute("disabled")}),d&&(d.style.display="none"),t.style.display="flex",i&&(i.style.display="block"),setTimeout(()=>{l.client_id&&$("#modal-client_id").val(l.client_id).trigger("change"),l.policy_id&&$("#modal-policy_id").val(l.policy_id).trigger("change"),l.auth_no&&$("#modal-category_id").val(l.auth_no).trigger("change"),$(".js-example-basic-single").select2({width:"100%",dropdownParent:$("#manageInsuranceModal")})},100)}).catch(s=>{console.error("Error loading insurance:",s),M("Error","Failed to load insurance details","error"),n.disabled=!1,n.innerHTML='<i class="fas fa-save"></i> Save'}))}window.deleteInsurance=function(e){Swal.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it!"}).then(t=>{if(t.isConfirmed){const i=document.querySelector('meta[name="csrf-token"]').content,a=`${insuranceUpdateUrl}/${e}`;fetch(a,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":i,"X-Requested-With":"XMLHttpRequest"}}).then(n=>n.json()).then(n=>{n.success?(w(),_(),Swal.fire("Deleted!","Insurance record has been deleted.","success")):Swal.fire("Error!",n.message||"Failed to delete insurance record.","error")}).catch(n=>{console.error("Error deleting insurance:",n),Swal.fire("Error!","An error occurred while deleting the record.","error")})}})};function Y(){$(".js-example-basic-single").each(function(){var e=$(this),t=e.siblings("label");e.val()?t.addClass("active"):t.removeClass("active")})}$(document).ready(function(){$(".js-example-basic-single").on("change",function(){Y()})});window.closeInsuranceModal=window.closeInsuranceModal||closeInsuranceModal;window.closeClientEditModal=window.closeClientEditModal||closeClientEditModal;window.closeCreateClientModal=window.closeCreateClientModal||closeCreateClientModal;window.submitClientEdit=window.submitClientEdit||submitClientEdit;window.submitCreateClient=window.submitCreateClient||submitCreateClient;window.deleteInsurance=window.deleteInsurance||deleteInsurance;window.viewInsuranceDetails=window.viewInsuranceDetails||J;window.editInsuranceDetails=window.editInsuranceDetails||editInsuranceDetails;
