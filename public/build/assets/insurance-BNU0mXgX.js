let v=!1;function E(e="perform this action"){if(window.userPermissions===0)return Swal.fire({title:"Subscription Required!",text:`Your subscription has expired or you don't have permission to ${e}. Please renew your subscription to continue using this feature.`,icon:"warning",showCancelButton:!0,confirmButtonText:"Renew Subscription",cancelButtonText:"Cancel",confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",allowOutsideClick:!1}).then(t=>{t.isConfirmed&&(window.location.href="/account/setting")}),!1;if(!window.currentUserSubscription||!window.currentUserSubscription.subscription_type)return Swal.fire({title:"Subscription Required!",text:`You don't have an active subscription. Please subscribe to ${e}.`,icon:"warning",showCancelButton:!0,confirmButtonText:"Subscribe Now",cancelButtonText:"Cancel",confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",allowOutsideClick:!1}).then(t=>{t.isConfirmed&&(window.location.href="/account/setting")}),!1;if(window.currentUserSubscription.subscription_type==="free_trial"){const t=window.currentUserSubscription.subscription_end_date?new Date(window.currentUserSubscription.subscription_end_date):window.currentUserSubscription.last_payment_date?new Date(new Date(window.currentUserSubscription.last_payment_date).setMonth(new Date(window.currentUserSubscription.last_payment_date).getMonth()+1)):null;if(t&&new Date>t)return Swal.fire({title:"Free Trial Ended!",text:`Your free trial has ended. Please upgrade your subscription to ${e}.`,icon:"warning",showCancelButton:!0,confirmButtonText:"Upgrade Now",cancelButtonText:"Cancel",confirmButtonColor:"#3085d6",cancelButtonColor:"#d33",allowOutsideClick:!1}).then(a=>{a.isConfirmed&&(window.location.href="/account/setting")}),!1}return!0}document.addEventListener("DOMContentLoaded",function(){P(),B(),T()});function P(){const e=document.getElementById("addInsuranceBtn");e&&e.addEventListener("click",function(c){if(!E("create new insurance records")){c.preventDefault(),c.stopPropagation();return}S()});const t=document.getElementById("addInsuranceEmptyBtn");t&&t.addEventListener("click",function(c){if(!E("create new insurance records")){c.preventDefault(),c.stopPropagation();return}S()});const a=document.getElementById("loadInsuranceDataBtn");a&&a.addEventListener("click",Z),document.querySelectorAll(".toggle-btn").forEach(c=>{c.addEventListener("click",function(){document.querySelectorAll(".toggle-btn").forEach(f=>f.classList.remove("active")),this.classList.add("active");const l=this.getAttribute("data-view"),s=document.getElementById("policiesGrid");s&&(s.classList.remove("grid-view","list-view"),l==="grid"?s.classList.add("grid-view"):l==="list"&&s.classList.add("list-view"))})});const i=document.getElementById("statusFilter");i&&i.addEventListener("change",function(){j(this.value)});const n=document.getElementById("insuranceForm");n&&n.addEventListener("submit",function(c){c.preventDefault();const l=document.getElementById("insuranceSubmitBtn");l&&l.disabled||(l&&(l.disabled=!0,l.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...'),G(c))});const r=document.getElementById("modal-registration_date");r&&r.addEventListener("change",function(){const c=this.value;if(!c)return;const l=new Date(c);l.setFullYear(l.getFullYear()+1);const s=document.getElementById("modal-expiration_date");s&&(s.value=l.toISOString().slice(0,10))})}function B(){fetch(insuranceDataUrl).then(e=>e.json()).then(e=>{A(e.data)}).catch(e=>{console.error("Error loading insurance data:",e),O("Error","Failed to load insurance data","error")})}function A(e){const t=document.getElementById("policiesGrid");if(!t)return;if(t.querySelectorAll(".policy-card").forEach(n=>n.remove()),!e||e.length===0){if(!t.querySelector(".empty-state")){const n=document.createElement("div");n.className="empty-state",n.innerHTML=`
                <div class="empty-icon">
                    <i class="fas fa-file-contract"></i>
                </div>
                <h3>No Insurance Policies Found</h3>
                <p>Get started by adding your first insurance policy</p>
                <button class="action-btn view" id="addInsuranceEmptyBtn">
                    <i class="fas fa-plus-circle"></i>
                    Add New Insurance
                </button>
            `,t.appendChild(n);const r=document.getElementById("addInsuranceEmptyBtn");r&&r.addEventListener("click",function(c){if(!E("create new insurance records")){c.preventDefault(),c.stopPropagation();return}S()})}return}const i=t.querySelector(".empty-state");i&&i.remove(),e.forEach(n=>{const r=q(n),c=D(n,r);t.appendChild(c)})}function D(e,t){const a=document.createElement("div");a.className="policy-card",a.setAttribute("data-status",t),a.setAttribute("data-id",e.id);const i=U(e.code),n=`${e.client_name||"N/A"}`,r=e.category_name||"Unknown Category",c=window.userId===1&&window.userOfficeId===0,l=e.office_name||"N/A",s=c?`
        <div class="detail-row">
            <span class="detail-label">Office:</span>
            <span class="detail-value">${l}</span>
        </div>
    `:"";return a.innerHTML=`
        <div class="card-header">
            <div class="policy-meta">
                <span class="policy-id">${e.mvfile_no||e.code||"N/A"}</span>
                <span class="policy-date">${H(e.registration_date)}</span>
            </div>
            <div class="status-badge ${t}">
                ${V(t)}
            </div>
        </div>
        
        <div class="card-body">
            <div class="client-info">
                <h3 class="client-name">${n}</h3>
                <div class="client-details">
                    <div class="detail-row">
                        <span class="detail-label">Category:</span>
                        <span class="detail-value">${r}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Plate No:</span>
                        <span class="detail-value">${e.registration_no||"N/A"}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">COC No:</span>
                        <span class="detail-value">${e.coc_no||"N/A"}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Engine No:</span>
                        <span class="detail-value">${e.engine_no||"N/A"}</span>
                    </div>
                    ${s}
                </div>
            </div>
            
            <div class="policy-type-indicator" style="--policy-color: ${i}">
                <span class="policy-type">${e.policy_name||"Standard"}</span>
            </div>
        </div>
        
        <div class="card-footer">
            <div class="action-buttons">
                <button class="action-btn-small view" onclick="viewInsuranceDetails(${e.id})">
                    <i class="fas fa-eye"></i> View
                </button>
                ${window.userPermissions>0?`<button class="action-btn-small edit" onclick="editInsuranceDetails(${e.id})">
                    <i class="fas fa-edit"></i> Edit
                </button>`:""}
                ${window.userPermissions===1?`<button class="action-btn-small delete" onclick="deleteInsurance(${e.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>`:""}
            </div>
        </div>
    `,a}function q(e){return e.expiration_date&&new Date(e.expiration_date)<new Date?"expired":e.status===1?"active":"pending"}function V(e){return{active:"Active",pending:"Pending",expired:"Expired"}[e]||"Pending"}function U(e){const t={liberty:"#FF6B6B",milestone:"#4ECDC4",pacific:"#45B7D1",stronghold:"#FFA07A"};if(!e)return"#6c757d";const a=e.toLowerCase();for(const[i,n]of Object.entries(t))if(a.includes(i))return n;return"#6c757d"}function H(e){if(!e)return"N/A";try{return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return e}}function j(e){const t=document.querySelectorAll(".policy-card");let a=0;t.forEach(i=>{const n=i.getAttribute("data-status");e==="all"||n===e?(i.style.display="flex",a++):i.style.display="none"}),X(a,e)}function X(e,t){const a=document.getElementById("policiesGrid");if(!a)return;const i=a.querySelector(".empty-state");if(e===0&&!i){const n=document.createElement("div");n.className="empty-state",n.innerHTML=`
            <div class="empty-icon">
                <i class="fas fa-search"></i>
            </div>
            <h3>No ${t==="all"?"":t+" "}Policies Found</h3>
            <p>No policies match the selected filter criteria</p>
        `,a.appendChild(n)}else e>0&&i&&i.remove()}function T(){const e={activeCount:0,pendingCount:0,expiredCount:0,totalCount:0};fetch(insuranceDataUrl).then(t=>t.json()).then(t=>{(t.data||[]).forEach(i=>{if(e.totalCount++,i.expiration_date&&new Date(i.expiration_date)<new Date){e.expiredCount++;return}i.status===1?e.activeCount++:e.pendingCount++}),J(e)}).catch(t=>console.error("Error loading statistics:",t))}function J(e){const t={activeCount:document.getElementById("activeCount"),pendingCount:document.getElementById("pendingCount"),expiredCount:document.getElementById("expiredCount"),totalCount:document.getElementById("totalCount")};for(const[a,i]of Object.entries(t))i&&(i.textContent=e[a]||0)}async function S(){if(!E("create new insurance records"))return;b(1);const e=await Y();if(!e){b(0);return}h=e,console.log("Stored global COC result:",h);const{cocNumber:t,orNumber:a,policyNumber:i}=e;b(2);const n=await z();if(!n){b(0);return}if(b(3),n.isCopy&&n.existingRecord){x(n.existingRecord,e,n);return}if(!n.existingRecord){W(e,n);return}b(4),N({mvfile_no:n.mvfile_no,coc_no:t,or_no:a||t,policy_no:i||t},n.existingRecord||null,n.isCopy||!1,null)}async function Y(){return new Promise(e=>{const t=document.createElement("div");t.className="modern-input-container",t.innerHTML=`
            <div class="input-header">
                <i class="fas fa-id-card"></i>
                <h3>Enter COC Number</h3>
            </div>
            <div class="tutorial-tip-box">
                <i class="fas fa-lightbulb"></i>
                <span><strong>Tip:</strong> COC (Certificate of Cover) is an 8-digit number found on your insurance certificate.</span>
            </div>
            <div class="input-wrapper">
                <input type="text" id="coc-input" class="modern-input" placeholder="12345678" maxlength="8" data-tutorial="coc-input">
                <div class="status-indicator" id="coc-status-indicator"></div>
            </div>
            <div class="status-message" id="coc-status-message"></div>
            <div id="additional-fields" class="additional-fields" style="display: none;">
                <div class="input-header">
                    <i class="fas fa-info-circle"></i>
                    <h3>Additional Information</h3>
                </div>
                <div class="tutorial-tip-box secondary">
                    <i class="fas fa-info-circle"></i>
                    <span>These fields are optional but help with record keeping.</span>
                </div>
                <div class="input-wrapper">
                    <input type="text" id="or-number" class="modern-input" placeholder="OR Number" data-tutorial="or-input">
                </div>
                <div class="input-wrapper">
                    <input type="text" id="policy-number" class="modern-input" placeholder="Policy Number" data-tutorial="policy-input">
                </div>
            </div>
        `,Swal.fire({title:"",html:t,showCancelButton:!0,confirmButtonText:"Continue",cancelButtonText:"Cancel",customClass:{popup:"modern-swal-popup tutorial-swal-popup",confirmButton:"modern-confirm-btn",cancelButton:"modern-cancel-btn"},didOpen:()=>{const a=document.getElementById("coc-input"),i=document.getElementById("coc-status-indicator"),n=document.getElementById("coc-status-message"),r=document.getElementById("additional-fields");a.addEventListener("input",async function(){const c=this.value.trim();if(!c){i.className="status-indicator",n.textContent="",r.style.display="none";return}if(!/^[0-9]{8}$/.test(c)){i.className="status-indicator invalid",n.textContent="Invalid format. Use 8 digits only",n.className="status-message error",r.style.display="none";return}i.className="status-indicator checking",n.textContent="Validating COC number...",n.className="status-message checking",r.style.display="none";try{const s=await(await fetch(insuranceValidateCocUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({coc_no:c})})).json();s.valid?(i.className="status-indicator valid",n.textContent="",r.style.display="block"):(i.className="status-indicator invalid",n.textContent=s.message||"COC number is invalid",n.className="status-message error",r.style.display="none")}catch(l){i.className="status-indicator error",n.textContent="Error validating COC number",n.className="status-message error",console.error(l)}})},preConfirm:()=>{var l,s;const i=document.getElementById("coc-input").value.trim();if(!i)return Swal.showValidationMessage("COC number is required!"),!1;if(!/^[0-9]{8}$/.test(i))return Swal.showValidationMessage("Invalid format. Use 8 digits only"),!1;if(!document.getElementById("coc-status-indicator").classList.contains("valid"))return Swal.showValidationMessage("Please fix COC number validation issues first"),!1;const r=((l=document.getElementById("or-number"))==null?void 0:l.value.trim())||"",c=((s=document.getElementById("policy-number"))==null?void 0:s.value.trim())||"";return{cocNumber:i,orNumber:r,policyNumber:c}}}).then(a=>{a.isConfirmed?e(a.value):e(null)})})}async function z(){let e=null,t=!1,a=!1,i=null,n=null,r="";return new Promise(c=>{const l=document.createElement("div");l.className="modern-input-container",l.innerHTML=`
            <div class="input-header">
                <i class="fas fa-car"></i>
                <h3>Bind MV File Number</h3>
            </div>
            <div class="tutorial-tip-box">
                <i class="fas fa-lightbulb"></i>
                <span><strong>Tip:</strong> MV File Number links this insurance to a specific vehicle. If the vehicle exists in another office, you can copy its data.</span>
            </div>
            <div class="input-wrapper">
                <input type="text" id="mvfile-input" class="modern-input" placeholder="Enter MV File Number (14 digits + 1 letter/number)" maxlength="15" pattern="[0-9]{14}[A-Za-z0-9]" data-tutorial="mvfile-input">
                <div class="status-indicator" id="status-indicator"></div>
            </div>
            <div class="status-message" id="status-message"></div>
            <div class="record-details" id="record-details" style="display: none;"></div>
        `,Swal.fire({title:"",html:l,showCancelButton:!0,confirmButtonText:"Bind & Continue",cancelButtonText:"Cancel",customClass:{popup:"modern-swal-popup tutorial-swal-popup",confirmButton:"modern-confirm-btn",cancelButton:"modern-cancel-btn"},didOpen:()=>{const s=document.getElementById("mvfile-input"),f=document.getElementById("status-indicator"),u=document.getElementById("status-message"),m=document.getElementById("record-details");s.addEventListener("input",function(){const d=this.value.trim();if(r=d,n&&clearTimeout(n),i&&(i.abort(),i=null),!d){f.className="status-indicator",u.textContent="",m.style.display="none",e=null,t=!1,a=!0,C();return}if(!/^[0-9]{14}[A-Za-z0-9]$/.test(d)){f.className="status-indicator invalid",u.textContent="Invalid format. Use 14 digits followed by 1 letter or number",u.className="status-message error",m.style.display="none",e=null,t=!1,a=!1,C();return}f.className="status-indicator checking",u.textContent="Checking MV File availability...",u.className="status-message checking",m.style.display="none",e=null,t=!1,a=!1,n=setTimeout(async()=>{var y;if(s.value.trim()===r){i=new AbortController;try{const p=await fetch(insuranceValidateMvFileUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({mvfile_no:d}),signal:i.signal});if(s.value.trim()!==r)return;const g=await p.json();if(a=!0,g.exists)g.sameOffice?(f.className="status-indicator valid",u.textContent="MV File found in your office records",u.className="status-message valid",e=g.record,t=!1,m.innerHTML=M(g.record,!1),m.style.display="block",te(g.record)):(f.className="status-indicator valid",u.textContent=`MV File found in ${((y=g.record)==null?void 0:y.source_office_name)||"another office"} - you can copy this data to your office`,u.className="status-message valid",e=g.record,t=!0,m.innerHTML=M(g.record,!0),m.style.display="block",C());else{f.className="status-indicator invalid",u.textContent="MV File not found - will create new record",u.className="status-message warning",m.style.display="none",e=null,t=!1,C();const w=document.querySelector(".swal2-confirm");w&&(w.disabled=!1,w.style.opacity="1",w.style.cursor="pointer")}}catch(p){if(p.name==="AbortError"||s.value.trim()!==r)return;a=!0,f.className="status-indicator error",u.textContent="Error checking MV File",u.className="status-message error",console.error(p)}finally{i=null}}},300)})},preConfirm:async()=>{const f=document.getElementById("mvfile-input").value.trim();if(!f)return Swal.showValidationMessage("MV File number is required!"),!1;if(!/^[0-9]{14}[A-Za-z0-9]$/.test(f))return Swal.showValidationMessage("Invalid format. Use 14 digits followed by 1 letter or number"),!1;if(n&&(clearTimeout(n),n=null),i&&(i.abort(),i=null),!a){statusIndicator.className="status-indicator checking",statusMessage.textContent="Validating...";try{const m=await(await fetch(insuranceValidateMvFileUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({mvfile_no:f})})).json();m.exists?(e=m.record,t=!m.sameOffice):(e=null,t=!1)}catch(u){console.error("Validation error:",u)}}return{mvfile_no:f,existingRecord:e,isCopy:t}}}).then(s=>{s.isConfirmed?c(s.value):c(null)})})}function M(e){return`
        <div class="record-card">
            <div class="record-header">
                <i class="fas fa-file-contract"></i>
                <h4>Existing Insurance Record</h4>
                <span class="verified-badge">Verified</span>
            </div>
            <div class="record-body">
                <div class="record-field">
                    <label>Policy Number:</label>
                    <span>${e.policy_no?"#"+e.policy_no:"N/A"}</span>
                </div>
                <div class="record-field">
                    <label>COC Number:</label>
                    <span>${e.coc_no||"N/A"}</span>
                </div>
                <div class="record-field">
                    <label>OR Number:</label>
                    <span>${e.or_no||"N/A"}</span>
                </div>
            </div>
        </div>
    `}let _=null,I=null,h=null;function x(e,t,a){const i=document.getElementById("clientEditModal"),n=document.getElementById("clientEditModalOverlay"),r=document.getElementById("clientEditForm");if(!i||!r)return;I=t,_=a,document.getElementById("edit-client-original-id").value=e.client_id||"",document.getElementById("edit-firstname").value=e.firstname||"",document.getElementById("edit-middlename").value=e.middlename||"",document.getElementById("edit-lastname").value=e.lastname||"",document.getElementById("edit-email").value=e.email||"",document.getElementById("edit-contact").value=e.contact||"",document.getElementById("edit-dob").value=e.dob||"",document.getElementById("edit-markup").value=e.markup||"",document.getElementById("edit-address").value=e.address||"";const c=`${e.firstname||""} ${e.middlename?e.middlename+" ":""}${e.lastname||""}`;document.getElementById("originalClientName").textContent=`Original: ${c}`,i.style.display="flex",n&&(n.style.display="block")}window.closeClientEditModal=function(){const e=document.getElementById("clientEditModal"),t=document.getElementById("clientEditModalOverlay");e&&(e.style.display="none"),t&&(t.style.display="none"),I=null,_=null};window.submitClientEdit=async function(){if(v)return;v=!0;const e=document.getElementById("clientEditContinueBtn");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Updating...'),document.getElementById("clientEditForm");const t=document.getElementById("edit-firstname").value.trim(),a=document.getElementById("edit-lastname").value.trim();if(!t){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-check-circle"></i> Continue to Insurance Form'),v=!1,Swal.fire({icon:"error",title:"Validation Error",text:"First name is required!"});return}if(!a){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-check-circle"></i> Continue to Insurance Form'),v=!1,Swal.fire({icon:"error",title:"Validation Error",text:"Last name is required!"});return}const i={firstname:t,middlename:document.getElementById("edit-middlename").value.trim(),lastname:a,email:document.getElementById("edit-email").value.trim(),contact:document.getElementById("edit-contact").value.trim(),dob:document.getElementById("edit-dob").value,walkin_list:document.getElementById("edit-markup").value.trim()||"Walk-in",address:document.getElementById("edit-address").value.trim()||"N/A",status:"1"},n=document.getElementById("edit-client-original-id").value;if(!n){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-check-circle"></i> Continue to Insurance Form'),v=!1,Swal.fire({icon:"error",title:"Error",text:"Client ID not found!"});return}try{const r=document.querySelector('meta[name="csrf-token"]').content,c=await fetch(`/clients/${n}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":r,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(i)}),l=await c.json();if(!c.ok)throw new Error(l.message||"Failed to update client");console.log("Client updated successfully:",l),Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,customClass:{popup:"colored-toast"}}).fire({icon:"success",title:"Client updated successfully"});const f=l.data||l.client;if(f){const y=`${f.lastname}, ${f.firstname}${f.middlename?" "+f.middlename:""}`,p=$("#modal-client_id"),g=p.find(`option[value="${f.id}"]`);if(g.length>0)g.text(y);else{const w=new Option(y,f.id,!0,!0);p.append(w)}p.trigger("change")}const u=document.querySelector(".swal2-confirm");u&&(u.disabled=!1,u.style.opacity="1",u.style.cursor="pointer");const m=_,d=I||h;console.log("Preparing to show MV File dialog again:",{localMvfileResult:m,localCocResult:d,globalCocResult:h}),closeClientEditModal(),m&&d?(Swal.close(),setTimeout(()=>{console.log("Calling showMvFileDialogAgain with:",{localMvfileResult:m,localCocResult:d,editedClientData:i}),L(m,d,i)},500)):console.error("Missing data to show MV File dialog:",{localMvfileResult:m,localCocResult:d,pendingMvfileResult:_,pendingCocResult:I,globalCocResult:h})}catch(r){console.error("Error updating client:",r),Swal.fire({icon:"error",title:"Error",text:r.message||"Failed to update client. Please try again."}),e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-check-circle"></i> Continue to Insurance Form')}finally{v=!1}};let k=null,F=null;function W(e,t){const a=document.getElementById("createClientModal"),i=document.getElementById("createClientModalOverlay"),n=document.getElementById("createClientForm");!a||!n||(k=e,F=t,n.reset(),a.style.display="flex",i&&(i.style.display="block"))}window.closeCreateClientModal=function(){const e=document.getElementById("createClientModal"),t=document.getElementById("createClientModalOverlay");e&&(e.style.display="none"),t&&(t.style.display="none"),k=null,F=null};window.submitCreateClient=async function(){if(v)return;v=!0;const e=document.getElementById("createClientSubmitBtn");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Creating...');const t=document.getElementById("create-firstname").value.trim(),a=document.getElementById("create-lastname").value.trim();if(!t){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Create Client'),Swal.fire({icon:"error",title:"Validation Error",text:"First name is required!"});return}if(!a){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Create Client'),Swal.fire({icon:"error",title:"Validation Error",text:"Last name is required!"});return}const i={firstname:t,middlename:document.getElementById("create-middlename").value.trim(),lastname:a,email:document.getElementById("create-email").value.trim(),contact:document.getElementById("create-contact").value.trim(),dob:document.getElementById("create-dob").value,walkin_list:document.getElementById("create-markup").value.trim()||"Walk-in",address:document.getElementById("create-address").value.trim()||"N/A",status:"1"};Swal.fire({title:"Creating Client...",allowOutsideClick:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}});try{const n=document.querySelector('meta[name="csrf-token"]').content,r=await fetch("/clients",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":n,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(i)}),c=await r.json();if(!r.ok)throw new Error(c.message||"Failed to create client");const l=c.data,s=l.id,f=`${l.lastname}, ${l.firstname}${l.middlename?" "+l.middlename:""}`;console.log("Client created successfully:",s,f),Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,customClass:{popup:"colored-toast"}}).fire({icon:"success",title:"Client created successfully"});const m=F,d=k||h;if(console.log("Stored results:",{localMvfileResult:m,localCocResult:d,globalCocResult:h}),closeCreateClientModal(),Swal.close(),m&&d){const y={id:s,firstname:i.firstname,middlename:i.middlename,lastname:i.lastname};Swal.close(),setTimeout(()=>{console.log("Calling showMvFileDialogAgain with:",{localMvfileResult:m,localCocResult:d,newClientData:y}),L(m,d,null,y)},500)}else console.error("Missing required data:",{localMvfileResult:m,localCocResult:d}),Swal.fire({icon:"error",title:"Error",text:"Failed to continue. Missing required data."});v=!1}catch(n){console.error("Error creating client:",n),Swal.fire({icon:"error",title:"Error",text:n.message||"Failed to create client. Please try again."})}finally{e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Create Client'),v=!1}};async function N(e,t,a=!1,i=null,n=null){console.log("showManageInsuranceModal called with:",{formData:e,existingRecord:t,isCopy:a,editedClientData:i,newClientId:n});const r=document.getElementById("manageInsuranceModal"),c=document.getElementById("insuranceModalOverlay"),l=document.getElementById("insuranceForm"),s=document.getElementById("insuranceSubmitBtn"),f=document.getElementById("manageInsuranceModalTitle"),u=document.getElementById("officeSelectGroup");if(console.log("Modal elements found:",{modal:!!r,overlay:!!c,form:!!l,submitBtn:!!s,modalTitle:!!f}),!r||!l){console.error("Modal or form not found! Cannot open insurance form.");return}if(document.getElementById("insurance_id").value="",document.getElementById("insurance_form_method").value="POST",o("modal-mvfile_no",e.mvfile_no||""),o("modal-coc_no",e.coc_no||""),o("modal-or_no",e.or_no||""),o("modal-policy_no",e.policy_no||""),t)if(a){document.getElementById("insurance_id").value="",document.getElementById("insurance_form_method").value="POST",f.textContent="Copy Insurance Record to Your Office",s.innerHTML='<i class="fas fa-copy"></i> Create Copy in Your Office',o("modal-client_id","clone_"+t.client_id),o("modal-policy_id",t.policy_id||"");let m=document.getElementById("modal-clone_client_id");if(m||(m=document.createElement("input"),m.type="hidden",m.id="modal-clone_client_id",l.appendChild(m)),m.value=t.client_id,i){let d=document.getElementById("modal-edited_client_data");d||(d=document.createElement("input"),d.type="hidden",d.id="modal-edited_client_data",d.name="edited_client_data",l.appendChild(d)),d.value=JSON.stringify(i)}if(o("modal-category_id",t.auth_no||""),o("modal-code",""),o("modal-registration_no",t.registration_no||""),o("modal-chassis_no",t.chassis_no||""),o("modal-engine_no",t.engine_no||""),o("modal-vehicle_model",t.vehicle_model||""),o("modal-vehicle_color",t.vehicle_color||""),o("modal-make",t.make||""),o("modal-registration_date",""),o("modal-expiration_date",""),o("modal-cost",""),o("modal-status","0"),o("modal-remarks",t.insurance_remarks||t.remarks||""),setTimeout(()=>{const d=i?i.firstname+" "+(i.middlename?i.middlename+" ":"")+i.lastname+" (Edited - Will be cloned to your office)":t.firstname+" "+(t.middlename?t.middlename+" ":"")+t.lastname+" (Will be cloned to your office)",y=$("#modal-client_id"),p=new Option(d,"clone_"+t.client_id,!0,!0);y.append(p).trigger("change"),t.policy_id&&$("#modal-policy_id").val(t.policy_id).trigger("change"),t.auth_no&&$("#modal-category_id").val(t.auth_no).trigger("change")},100),u&&window.isSuperAdmin){u.style.display="block";const d=document.getElementById("modal-office_id");d&&(d.value="")}else u&&(u.style.display="none")}else document.getElementById("insurance_id").value=t.insurance_id||"",document.getElementById("insurance_form_method").value="PUT",o("modal-client_id",t.client_id||""),o("modal-policy_id",t.policy_id||""),o("modal-category_id",t.auth_no||""),o("modal-code",t.insurance_code||t.code||""),o("modal-registration_no",t.registration_no||""),o("modal-chassis_no",t.chassis_no||""),o("modal-engine_no",t.engine_no||""),o("modal-vehicle_model",t.vehicle_model||""),o("modal-vehicle_color",t.vehicle_color||""),o("modal-make",t.make||""),o("modal-registration_date",t.registration_date||""),o("modal-expiration_date",t.expiration_date||""),o("modal-cost",t.cost??""),o("modal-status",String(t.insurance_status??t.status??"0")),o("modal-remarks",t.insurance_remarks||t.remarks||""),f.textContent="Edit Insurance",s.innerHTML='<i class="fas fa-save"></i> Update',setTimeout(()=>{t.client_id&&$("#modal-client_id").val(t.client_id).trigger("change"),t.policy_id&&$("#modal-policy_id").val(t.policy_id).trigger("change"),t.auth_no&&$("#modal-category_id").val(t.auth_no).trigger("change")},100),u&&(u.style.display="none");else if(n?o("modal-client_id",n):o("modal-client_id",""),o("modal-policy_id",""),o("modal-category_id",""),o("modal-registration_no",""),o("modal-chassis_no",""),o("modal-engine_no",""),o("modal-vehicle_model",""),o("modal-vehicle_color",""),o("modal-make",""),o("modal-registration_date",""),o("modal-expiration_date",""),o("modal-cost",""),o("modal-status","0"),o("modal-remarks",""),f.textContent="New Insurance",s.innerHTML='<i class="fas fa-save"></i> Save',setTimeout(()=>{n?$("#modal-client_id").val(n).trigger("change"):$("#modal-client_id").val("").trigger("change"),$("#modal-policy_id").val("").trigger("change"),$("#modal-category_id").val("").trigger("change")},100),u&&window.isSuperAdmin){u.style.display="block";const m=document.getElementById("modal-office_id");m&&(m.value="")}else u&&(u.style.display="none");r.style.setProperty("display","flex","important"),r.style.setProperty("visibility","visible","important"),r.style.setProperty("opacity","1","important"),r.style.setProperty("z-index","9999","important"),c&&(c.style.setProperty("display","block","important"),c.style.setProperty("visibility","visible","important"),c.style.setProperty("opacity","1","important"),c.style.setProperty("z-index","9998","important")),console.log("Modal display styles set:",{modalDisplay:r.style.display,modalVisibility:r.style.visibility,modalOpacity:r.style.opacity,modalZIndex:r.style.zIndex}),setTimeout(()=>{$(".js-example-basic-single").select2({width:"100%",dropdownParent:$("#manageInsuranceModal")}),(r.style.display==="none"||window.getComputedStyle(r).display==="none")&&(console.warn("Modal was hidden after Select2 init, forcing visible again"),r.style.setProperty("display","flex","important"))},200)}function o(e,t){const a=document.getElementById(e);if(!a)return;const i=t==null?"":String(t);a.classList.contains("js-example-basic-single"),a.value=i}window.closeInsuranceModal=function(){const e=document.getElementById("manageInsuranceModal"),t=document.getElementById("insuranceModalOverlay");e&&(e.style.display="none"),t&&(t.style.display="none")};async function G(e){var m;e.preventDefault();const t=document.getElementById("insuranceForm"),a=document.getElementById("insuranceSubmitBtn");if(!t)return;const i=document.getElementById("insurance_id").value,n=!!i,r=new FormData(t),c={};r.forEach((d,y)=>{y==="_token"||y==="_method"||y==="insurance_id"||(c[y]=d)});const l=document.getElementById("modal-edited_client_data");if(l&&l.value)try{c.edited_client_data=JSON.parse(l.value)}catch(d){console.error("Error parsing edited client data:",d)}if(!n&&window.isSuperAdmin){const d=(m=document.getElementById("modal-office_id"))==null?void 0:m.value;d&&(c.office_id=d)}const s=n?`${insuranceUpdateUrl}/${i}`:insuranceStoreUrl,f=n?"PUT":"POST",u=document.querySelector('meta[name="csrf-token"]').content;a&&(a.disabled=!0,a.innerHTML='<i class="fas fa-spinner fa-spin"></i> '+(n?"Updating...":"Saving..."));try{const d={method:f,headers:{"Content-Type":"application/json","X-CSRF-TOKEN":u,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(c)};f==="PUT"&&(d.headers["X-HTTP-Method-Override"]="PUT");const y=await fetch(s,d),p=await y.json().catch(()=>({}));if(!y.ok){if(y.status===422&&p&&p.message)throw closeInsuranceModal(),new Error(p.message);const w=p&&typeof p=="object"&&p.errors&&typeof p.errors=="object"?Object.values(p.errors).flat().filter(Boolean).join(" "):p&&typeof p=="object"&&p.message||"Request failed";throw new Error(w)}B(),T();let g=i;!g&&p&&p.insurance&&p.insurance.id&&(g=p.insurance.id),closeInsuranceModal(),Swal.fire({title:"Success!",text:n?"Insurance record updated successfully!":"Insurance record added successfully!",icon:"success",timer:2e3,showConfirmButton:!1}).then(()=>{g&&(window.location.href=`/insurances/${g}`)})}catch(d){typeof Swal<"u"?Swal.fire({icon:"error",title:"Error",text:d.message||"Something went wrong."}):alert(d.message||"Something went wrong.")}finally{a&&(a.disabled=!1,a.innerHTML=n?'<i class="fas fa-save"></i> Update':'<i class="fas fa-save"></i> Save'),v=!1}}function K(e){window.location.href=`/insurances/${e}`}function Z(){Swal.fire({title:"Load Data",input:"select",inputOptions:{10:"Load 10 Records",50:"Load 50 Records",100:"Load 100 Records",500:"Load 500 Records"},inputPlaceholder:"Select batch size",showCancelButton:!0,confirmButtonText:"Load",customClass:{popup:"modern-swal-popup",confirmButton:"modern-confirm-btn",cancelButton:"modern-cancel-btn"}}).then(e=>{e.isConfirmed&&Q(e.value)})}function Q(e){Swal.fire({title:"Loading Data...",html:'<div style="width: 100%; background: #f3f3f3; border-radius: 25px; overflow: hidden;"><div id="data-progress" style="width: 0%; height: 20px; background: linear-gradient(90deg, #1877f2, #7209b7);"></div></div>',allowOutsideClick:!1,showConfirmButton:!1,didOpen:()=>{let t=0;const a=setInterval(()=>{t+=5;const i=document.getElementById("data-progress");i&&(i.style.width=t+"%"),t>=100&&clearInterval(a)},100);setTimeout(()=>{B(),Swal.close(),O("Success","Data loaded successfully","success")},2e3)}})}function b(e){document.querySelectorAll(".flow-step").forEach(t=>{t.classList.remove("active"),parseInt(t.getAttribute("data-step"))<=e&&t.classList.add("active")})}function O(e,t,a){Swal.fire({title:e,text:t,icon:a,customClass:{popup:"modern-swal-popup",confirmButton:"modern-confirm-btn"}})}window.viewInsuranceDetails=function(e){window.location.href=`/insurances/${e}`};window.editInsuranceDetails=function(e){R(e)};function R(e){if(!E("edit insurance records"))return;const t=document.getElementById("manageInsuranceModal"),a=document.getElementById("insuranceModalOverlay"),i=document.getElementById("insuranceForm"),n=document.getElementById("insuranceSubmitBtn"),r=document.getElementById("manageInsuranceModalTitle"),c=document.getElementById("officeSelectGroup");!t||!i||(n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Loading...',fetch(`${manageInsuranceUrl}?id=${e}`).then(l=>l.json()).then(l=>{if(!l.insurance)throw new Error("Insurance not found");const s=l.insurance;document.getElementById("insurance_id").value=s.id,document.getElementById("insurance_form_method").value="PUT",o("modal-mvfile_no",s.mvfile_no||""),o("modal-coc_no",s.coc_no||""),o("modal-or_no",s.or_no||""),o("modal-policy_no",s.policy_no||""),o("modal-registration_no",s.registration_no||""),o("modal-chassis_no",s.chassis_no||""),o("modal-engine_no",s.engine_no||""),o("modal-vehicle_model",s.vehicle_model||""),o("modal-vehicle_color",s.vehicle_color||""),o("modal-make",s.make||""),o("modal-registration_date",s.registration_date||""),o("modal-expiration_date",s.expiration_date||""),o("modal-cost",s.cost||""),o("modal-status",String(s.status||"0")),o("modal-remarks",s.remarks||""),r.textContent="Edit Insurance",n.innerHTML='<i class="fas fa-save"></i> Update',n.disabled=!1,n.onclick=null,i.querySelectorAll(".form-control").forEach(u=>{u.removeAttribute("readonly"),u.removeAttribute("disabled")}),c&&(c.style.display="none"),t.style.display="flex",a&&(a.style.display="block"),setTimeout(()=>{s.client_id&&$("#modal-client_id").val(s.client_id).trigger("change"),s.policy_id&&$("#modal-policy_id").val(s.policy_id).trigger("change"),s.auth_no&&$("#modal-category_id").val(s.auth_no).trigger("change"),$(".js-example-basic-single").select2({width:"100%",dropdownParent:$("#manageInsuranceModal")})},100)}).catch(l=>{console.error("Error loading insurance:",l),O("Error","Failed to load insurance details","error"),n.disabled=!1,n.innerHTML='<i class="fas fa-save"></i> Save'}))}window.deleteInsurance=function(e){E("delete insurance records")&&Swal.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it!"}).then(t=>{if(t.isConfirmed){const a=document.querySelector('meta[name="csrf-token"]').content,i=`${insuranceUpdateUrl}/${e}`;fetch(i,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":a,"X-Requested-With":"XMLHttpRequest"}}).then(n=>n.json()).then(n=>{n.success?(B(),T(),Swal.fire("Deleted!","Insurance record has been deleted.","success")):Swal.fire("Error!",n.message||"Failed to delete insurance record.","error")}).catch(n=>{console.error("Error deleting insurance:",n),Swal.fire("Error!","An error occurred while deleting the record.","error")})}})};function ee(){$(".js-example-basic-single").each(function(){var e=$(this),t=e.siblings("label");e.val()?t.addClass("active"):t.removeClass("active")})}$(document).ready(function(){$(".js-example-basic-single").on("change",function(){ee()})});function te(e){const t=document.getElementById("mvfileNotification");if(!t)return;t.dataset.record=JSON.stringify(e);const a=e.walkin_list||e.markup||"N/A",i=t.querySelector(".notification-text");i&&(i.innerHTML=`
            <h4>Vehicle Found in Your Office</h4>
            <p style="font-weight: bold; color: #007bff; margin-bottom: 8px;">Previous Liaison: <span style="font-weight: normal; color: #dc3545;">${a}</span></p>
            <p style="margin-top: 0;">Some old clients may have transferred their name/vehicle. Would you like to edit the client information first?</p>
            `),t.classList.remove("hidden"),t.style.display="block";const n=document.querySelector(".swal2-confirm");n&&(n.disabled=!0,n.style.opacity="0.5",n.style.cursor="not-allowed")}function C(){const e=document.getElementById("mvfileNotification");e&&(e.classList.add("hidden"),setTimeout(()=>{e.style.display="none"},300))}window.skipClientEdit=function(){C();const e=document.querySelector(".swal2-confirm");e&&(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer")};window.transferClientEdit=function(){const e=document.getElementById("mvfileNotification");if(!e)return;const t=e.dataset.record;if(t)try{const a=JSON.parse(t);C(),x(a,h,{mvfile_no:a.mvfile_no,existingRecord:a,isCopy:!1})}catch(a){console.error("Error parsing record data:",a)}};function L(e,t,a=null,i=null){console.log("showMvFileDialogAgain called with:",{mvfileResult:e,cocResult:t,editedClientData:a,newClientData:i}),Swal.close(),setTimeout(()=>{const n=document.createElement("div");n.className="modern-input-container";let r="";a?r=`<div class="status-message valid" style="margin-bottom: 15px;"><i class="fas fa-check-circle"></i> Client updated: <strong>${`${a.firstname} ${a.middlename?a.middlename+" ":""}${a.lastname}`}</strong></div>`:i&&(r=`<div class="status-message valid" style="margin-bottom: 15px;"><i class="fas fa-check-circle"></i> New client created: <strong>${`${i.firstname} ${i.middlename?i.middlename+" ":""}${i.lastname}`}</strong></div>`);const c=e.existingRecord||{mvfile_no:e.mvfile_no};n.innerHTML=`
            <div class="input-header">
                <i class="fas fa-car"></i>
                <h3>Bind MV File Number</h3>
            </div>
            ${r}
            <div class="tutorial-tip-box">
                <i class="fas fa-lightbulb"></i>
                <span><strong>Tip:</strong> Review the MV File information below, then click "Bind & Continue" to proceed to the insurance form.</span>
            </div>
            <div class="input-wrapper">
                <input type="text" id="mvfile-input" class="modern-input" value="${e.mvfile_no}" readonly>
                <div class="status-indicator valid"></div>
            </div>
            <div class="status-message valid">MV File ready to bind</div>
            <div class="record-details" id="record-details">
                ${M(c)}
            </div>
        `,console.log("Opening Swal dialog for MV File"),Swal.fire({title:"",html:n,showCancelButton:!0,confirmButtonText:"Bind & Continue",cancelButtonText:"Cancel",allowOutsideClick:!1,customClass:{popup:"modern-swal-popup tutorial-swal-popup",confirmButton:"modern-confirm-btn",cancelButton:"modern-cancel-btn"},didOpen:()=>{console.log("MV File dialog opened successfully")}}).then(l=>{console.log("MV File dialog result:",l),l.isConfirmed&&(b(4),a?N({mvfile_no:e.mvfile_no,coc_no:t.cocNumber,or_no:t.orNumber||t.cocNumber,policy_no:t.policyNumber||t.cocNumber},e.existingRecord||null,e.isCopy||!1,a):i&&N({mvfile_no:e.mvfile_no,coc_no:t.cocNumber,or_no:t.orNumber||t.cocNumber,policy_no:t.policyNumber||t.cocNumber},null,!1,null,i.id))}).catch(l=>{console.error("Error showing MV File dialog:",l)})},100)}window.closeInsuranceModal=window.closeInsuranceModal||closeInsuranceModal;window.closeClientEditModal=window.closeClientEditModal||closeClientEditModal;window.closeCreateClientModal=window.closeCreateClientModal||closeCreateClientModal;window.submitClientEdit=window.submitClientEdit||submitClientEdit;window.submitCreateClient=window.submitCreateClient||submitCreateClient;window.deleteInsurance=window.deleteInsurance||deleteInsurance;window.viewInsuranceDetails=window.viewInsuranceDetails||K;window.editInsuranceDetails=window.editInsuranceDetails||editInsuranceDetails;window.skipClientEdit=window.skipClientEdit||skipClientEdit;window.transferClientEdit=window.transferClientEdit||transferClientEdit;window.showMvFileDialogAgain=window.showMvFileDialogAgain||L;
