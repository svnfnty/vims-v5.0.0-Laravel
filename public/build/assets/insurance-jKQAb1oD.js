let g=!1;document.addEventListener("DOMContentLoaded",function(){L(),b(),C()});function L(){const e=document.getElementById("addInsuranceBtn");e&&e.addEventListener("click",_);const t=document.getElementById("addInsuranceEmptyBtn");t&&t.addEventListener("click",_);const i=document.getElementById("loadInsuranceDataBtn");i&&i.addEventListener("click",K),document.querySelectorAll(".toggle-btn").forEach(r=>{r.addEventListener("click",function(){document.querySelectorAll(".toggle-btn").forEach(f=>f.classList.remove("active")),this.classList.add("active");const s=this.getAttribute("data-view"),o=document.getElementById("policiesGrid");o&&(o.classList.remove("grid-view","list-view"),s==="grid"?o.classList.add("grid-view"):s==="list"&&o.classList.add("list-view"))})});const a=document.getElementById("statusFilter");a&&a.addEventListener("change",function(){j(this.value)});const n=document.getElementById("insuranceForm");n&&n.addEventListener("submit",function(r){r.preventDefault();const s=document.getElementById("insuranceSubmitBtn");s&&s.disabled||(s&&(s.disabled=!0,s.innerHTML='<i class="fas fa-spinner fa-spin"></i> Saving...'),G(r))});const c=document.getElementById("modal-registration_date");c&&c.addEventListener("change",function(){const r=this.value;if(!r)return;const s=new Date(r);s.setFullYear(s.getFullYear()+1);const o=document.getElementById("modal-expiration_date");o&&(o.value=s.toISOString().slice(0,10))})}function b(){fetch(insuranceDataUrl).then(e=>e.json()).then(e=>{F(e.data)}).catch(e=>{console.error("Error loading insurance data:",e),T("Error","Failed to load insurance data","error")})}function F(e){const t=document.getElementById("policiesGrid");if(!t)return;if(t.querySelectorAll(".policy-card").forEach(n=>n.remove()),!e||e.length===0){if(!t.querySelector(".empty-state")){const n=document.createElement("div");n.className="empty-state",n.innerHTML=`
                <div class="empty-icon">
                    <i class="fas fa-file-contract"></i>
                </div>
                <h3>No Insurance Policies Found</h3>
                <p>Get started by adding your first insurance policy</p>
                <button class="action-btn view" id="addInsuranceEmptyBtn">
                    <i class="fas fa-plus-circle"></i>
                    Add New Insurance
                </button>
            `,t.appendChild(n);const c=document.getElementById("addInsuranceEmptyBtn");c&&c.addEventListener("click",_)}return}const a=t.querySelector(".empty-state");a&&a.remove(),e.forEach(n=>{const c=P(n),r=x(n,c);t.appendChild(r)})}function x(e,t){const i=document.createElement("div");i.className="policy-card",i.setAttribute("data-status",t),i.setAttribute("data-id",e.id);const a=A(e.code),n=`${e.client_name||"N/A"}`,c=e.category_name||"Unknown Category",r=window.userId===1&&window.userOfficeId===0,s=e.office_name||"N/A",o=r?`
        <div class="detail-row">
            <span class="detail-label">Office:</span>
            <span class="detail-value">${s}</span>
        </div>
    `:"";return i.innerHTML=`
        <div class="card-header">
            <div class="policy-meta">
                <span class="policy-id">${e.mvfile_no||e.code||"N/A"}</span>
                <span class="policy-date">${q(e.registration_date)}</span>
            </div>
            <div class="status-badge ${t}">
                ${D(t)}
            </div>
        </div>
        
        <div class="card-body">
            <div class="client-info">
                <h3 class="client-name">${n}</h3>
                <div class="client-details">
                    <div class="detail-row">
                        <span class="detail-label">Category:</span>
                        <span class="detail-value">${c}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Plate No:</span>
                        <span class="detail-value">${e.registration_no||"N/A"}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">COC No:</span>
                        <span class="detail-value">${e.coc_no||"N/A"}</span>
                    </div>
                    <div class="detail-row">
                        <span class="detail-label">Engine No:</span>
                        <span class="detail-value">${e.engine_no||"N/A"}</span>
                    </div>
                    ${o}
                </div>
            </div>
            
            <div class="policy-type-indicator" style="--policy-color: ${a}">
                <span class="policy-type">${e.policy_name||"Standard"}</span>
            </div>
        </div>
        
        <div class="card-footer">
            <div class="action-buttons">
                <button class="action-btn-small view" onclick="viewInsuranceDetails(${e.id})">
                    <i class="fas fa-eye"></i> View
                </button>
                ${window.userPermissions>0?`<button class="action-btn-small edit" onclick="editInsuranceDetails(${e.id})">
                    <i class="fas fa-edit"></i> Edit
                </button>`:""}
                ${window.userPermissions===1?`<button class="action-btn-small delete" onclick="deleteInsurance(${e.id})">
                    <i class="fas fa-trash"></i> Delete
                </button>`:""}
            </div>
        </div>
    `,i}function P(e){return e.expiration_date&&new Date(e.expiration_date)<new Date?"expired":e.status===1?"active":"pending"}function D(e){return{active:"Active",pending:"Pending",expired:"Expired"}[e]||"Pending"}function A(e){const t={liberty:"#FF6B6B",milestone:"#4ECDC4",pacific:"#45B7D1",stronghold:"#FFA07A"};if(!e)return"#6c757d";const i=e.toLowerCase();for(const[a,n]of Object.entries(t))if(i.includes(a))return n;return"#6c757d"}function q(e){if(!e)return"N/A";try{return new Date(e).toLocaleDateString("en-US",{year:"numeric",month:"short",day:"numeric"})}catch{return e}}function j(e){const t=document.querySelectorAll(".policy-card");let i=0;t.forEach(a=>{const n=a.getAttribute("data-status");e==="all"||n===e?(a.style.display="flex",i++):a.style.display="none"}),H(i,e)}function H(e,t){const i=document.getElementById("policiesGrid");if(!i)return;const a=i.querySelector(".empty-state");if(e===0&&!a){const n=document.createElement("div");n.className="empty-state",n.innerHTML=`
            <div class="empty-icon">
                <i class="fas fa-search"></i>
            </div>
            <h3>No ${t==="all"?"":t+" "}Policies Found</h3>
            <p>No policies match the selected filter criteria</p>
        `,i.appendChild(n)}else e>0&&a&&a.remove()}function C(){const e={activeCount:0,pendingCount:0,expiredCount:0,totalCount:0};fetch(insuranceDataUrl).then(t=>t.json()).then(t=>{(t.data||[]).forEach(a=>{if(e.totalCount++,a.expiration_date&&new Date(a.expiration_date)<new Date){e.expiredCount++;return}a.status===1?e.activeCount++:e.pendingCount++}),V(e)}).catch(t=>console.error("Error loading statistics:",t))}function V(e){const t={activeCount:document.getElementById("activeCount"),pendingCount:document.getElementById("pendingCount"),expiredCount:document.getElementById("expiredCount"),totalCount:document.getElementById("totalCount")};for(const[i,a]of Object.entries(t))a&&(a.textContent=e[i]||0)}async function _(){h(1);const e=await U();if(!e){h(0);return}const{cocNumber:t,orNumber:i,policyNumber:a}=e;h(2);const n=await X();if(!n){h(0);return}if(h(3),n.isCopy&&n.existingRecord){O(n.existingRecord,e,n);return}if(!n.existingRecord){J(e,n);return}h(4),N({mvfile_no:n.mvfile_no,coc_no:t,or_no:i||t,policy_no:a||t},n.existingRecord||null,n.isCopy||!1,null)}async function U(){return new Promise(e=>{const t=document.createElement("div");t.className="modern-input-container",t.innerHTML=`
            <div class="input-header">
                <i class="fas fa-id-card"></i>
                <h3>Enter COC Number</h3>
            </div>
            <div class="tutorial-tip-box">
                <i class="fas fa-lightbulb"></i>
                <span><strong>Tip:</strong> COC (Certificate of Cover) is an 8-digit number found on your insurance certificate.</span>
            </div>
            <div class="input-wrapper">
                <input type="text" id="coc-input" class="modern-input" placeholder="12345678" maxlength="8" data-tutorial="coc-input">
                <div class="status-indicator" id="coc-status-indicator"></div>
            </div>
            <div class="status-message" id="coc-status-message"></div>
            <div id="additional-fields" class="additional-fields" style="display: none;">
                <div class="input-header">
                    <i class="fas fa-info-circle"></i>
                    <h3>Additional Information</h3>
                </div>
                <div class="tutorial-tip-box secondary">
                    <i class="fas fa-info-circle"></i>
                    <span>These fields are optional but help with record keeping.</span>
                </div>
                <div class="input-wrapper">
                    <input type="text" id="or-number" class="modern-input" placeholder="OR Number" data-tutorial="or-input">
                </div>
                <div class="input-wrapper">
                    <input type="text" id="policy-number" class="modern-input" placeholder="Policy Number" data-tutorial="policy-input">
                </div>
            </div>
        `,Swal.fire({title:"",html:t,showCancelButton:!0,confirmButtonText:"Continue",cancelButtonText:"Cancel",customClass:{popup:"modern-swal-popup tutorial-swal-popup",confirmButton:"modern-confirm-btn",cancelButton:"modern-cancel-btn"},didOpen:()=>{const i=document.getElementById("coc-input"),a=document.getElementById("coc-status-indicator"),n=document.getElementById("coc-status-message"),c=document.getElementById("additional-fields");i.addEventListener("input",async function(){const r=this.value.trim();if(!r){a.className="status-indicator",n.textContent="",c.style.display="none";return}if(!/^[0-9]{8}$/.test(r)){a.className="status-indicator invalid",n.textContent="Invalid format. Use 8 digits only",n.className="status-message error",c.style.display="none";return}a.className="status-indicator checking",n.textContent="Validating COC number...",n.className="status-message checking",c.style.display="none";try{const o=await(await fetch(insuranceValidateCocUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({coc_no:r})})).json();o.valid?(a.className="status-indicator valid",n.textContent="",c.style.display="block"):(a.className="status-indicator invalid",n.textContent=o.message||"COC number is invalid",n.className="status-message error",c.style.display="none")}catch(s){a.className="status-indicator error",n.textContent="Error validating COC number",n.className="status-message error",console.error(s)}})},preConfirm:()=>{var s,o;const a=document.getElementById("coc-input").value.trim();if(!a)return Swal.showValidationMessage("COC number is required!"),!1;if(!/^[0-9]{8}$/.test(a))return Swal.showValidationMessage("Invalid format. Use 8 digits only"),!1;if(!document.getElementById("coc-status-indicator").classList.contains("valid"))return Swal.showValidationMessage("Please fix COC number validation issues first"),!1;const c=((s=document.getElementById("or-number"))==null?void 0:s.value.trim())||"",r=((o=document.getElementById("policy-number"))==null?void 0:o.value.trim())||"";return{cocNumber:a,orNumber:c,policyNumber:r}}}).then(i=>{i.isConfirmed?e(i.value):e(null)})})}async function X(){let e=null,t=!1,i=!1,a=null,n=null,c="";return new Promise(r=>{const s=document.createElement("div");s.className="modern-input-container",s.innerHTML=`
            <div class="input-header">
                <i class="fas fa-car"></i>
                <h3>Bind MV File Number</h3>
            </div>
            <div class="tutorial-tip-box">
                <i class="fas fa-lightbulb"></i>
                <span><strong>Tip:</strong> MV File Number links this insurance to a specific vehicle. If the vehicle exists in another office, you can copy its data.</span>
            </div>
            <div class="input-wrapper">
                <input type="text" id="mvfile-input" class="modern-input" placeholder="Enter MV File Number" data-tutorial="mvfile-input">
                <div class="status-indicator" id="status-indicator"></div>
            </div>
            <div class="status-message" id="status-message"></div>
            <div class="record-details" id="record-details" style="display: none;"></div>
        `,Swal.fire({title:"",html:s,showCancelButton:!0,confirmButtonText:"Bind & Continue",cancelButtonText:"Cancel",customClass:{popup:"modern-swal-popup tutorial-swal-popup",confirmButton:"modern-confirm-btn",cancelButton:"modern-cancel-btn"},didOpen:()=>{const o=document.getElementById("mvfile-input"),f=document.getElementById("status-indicator"),d=document.getElementById("status-message"),u=document.getElementById("record-details");o.addEventListener("input",function(){const m=this.value.trim();if(c=m,n&&clearTimeout(n),a&&(a.abort(),a=null),!m){f.className="status-indicator",d.textContent="",u.style.display="none",e=null,t=!1,i=!0,E();return}f.className="status-indicator checking",d.textContent="Checking MV File availability...",d.className="status-message checking",u.style.display="none",e=null,t=!1,i=!1,n=setTimeout(async()=>{var y;if(o.value.trim()===c){a=new AbortController;try{const p=await fetch(insuranceValidateMvFileUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({mvfile_no:m}),signal:a.signal});if(o.value.trim()!==c)return;const v=await p.json();if(i=!0,v.exists)v.sameOffice?(f.className="status-indicator valid",d.textContent="MV File found in your office records",d.className="status-message valid",e=v.record,t=!1,u.innerHTML=k(v.record,!1),u.style.display="block",Q(v.record)):(f.className="status-indicator valid",d.textContent=`MV File found in ${((y=v.record)==null?void 0:y.source_office_name)||"another office"} - you can copy this data to your office`,d.className="status-message valid",e=v.record,t=!0,u.innerHTML=k(v.record,!0),u.style.display="block",E());else{f.className="status-indicator invalid",d.textContent="MV File not found - will create new record",d.className="status-message warning",u.style.display="none",e=null,t=!1,E();const w=document.querySelector(".swal2-confirm");w&&(w.disabled=!1,w.style.opacity="1",w.style.cursor="pointer")}}catch(p){if(p.name==="AbortError"||o.value.trim()!==c)return;i=!0,f.className="status-indicator error",d.textContent="Error checking MV File",d.className="status-message error",console.error(p)}finally{a=null}}},300)})},preConfirm:async()=>{const f=document.getElementById("mvfile-input").value.trim();if(!f)return Swal.showValidationMessage("MV File number is required!"),!1;if(n&&(clearTimeout(n),n=null),a&&(a.abort(),a=null),!i){statusIndicator.className="status-indicator checking",statusMessage.textContent="Validating...";try{const u=await(await fetch(insuranceValidateMvFileUrl,{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":document.querySelector('meta[name="csrf-token"]').content},body:JSON.stringify({mvfile_no:f})})).json();u.exists?(e=u.record,t=!u.sameOffice):(e=null,t=!1)}catch(d){console.error("Validation error:",d)}}return{mvfile_no:f,existingRecord:e,isCopy:t}}}).then(o=>{o.isConfirmed?r(o.value):r(null)})})}function k(e){return`
        <div class="record-card">
            <div class="record-header">
                <i class="fas fa-file-contract"></i>
                <h4>Existing Insurance Record</h4>
                <span class="verified-badge">Verified</span>
            </div>
            <div class="record-body">
                <div class="record-field">
                    <label>Policy Number:</label>
                    <span>${e.policy_no?"#"+e.policy_no:"N/A"}</span>
                </div>
                <div class="record-field">
                    <label>COC Number:</label>
                    <span>${e.coc_no||"N/A"}</span>
                </div>
                <div class="record-field">
                    <label>OR Number:</label>
                    <span>${e.or_no||"N/A"}</span>
                </div>
            </div>
        </div>
    `}let I=null,B=null;function O(e,t,i){const a=document.getElementById("clientEditModal"),n=document.getElementById("clientEditModalOverlay"),c=document.getElementById("clientEditForm");if(!a||!c)return;B=t,I=i,document.getElementById("edit-client-original-id").value=e.client_id||"",document.getElementById("edit-firstname").value=e.firstname||"",document.getElementById("edit-middlename").value=e.middlename||"",document.getElementById("edit-lastname").value=e.lastname||"",document.getElementById("edit-email").value=e.email||"",document.getElementById("edit-contact").value=e.contact||"",document.getElementById("edit-dob").value=e.dob||"",document.getElementById("edit-markup").value=e.markup||"",document.getElementById("edit-address").value=e.address||"";const r=`${e.firstname||""} ${e.middlename?e.middlename+" ":""}${e.lastname||""}`;document.getElementById("originalClientName").textContent=`Original: ${r}`,a.style.display="flex",n&&(n.style.display="block")}window.closeClientEditModal=function(){const e=document.getElementById("clientEditModal"),t=document.getElementById("clientEditModalOverlay");e&&(e.style.display="none"),t&&(t.style.display="none"),B=null,I=null};window.submitClientEdit=async function(){if(g)return;g=!0;const e=document.getElementById("clientEditContinueBtn");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Updating...'),document.getElementById("clientEditForm");const t=document.getElementById("edit-firstname").value.trim(),i=document.getElementById("edit-lastname").value.trim();if(!t){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-check-circle"></i> Continue to Insurance Form'),g=!1,Swal.fire({icon:"error",title:"Validation Error",text:"First name is required!"});return}if(!i){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-check-circle"></i> Continue to Insurance Form'),g=!1,Swal.fire({icon:"error",title:"Validation Error",text:"Last name is required!"});return}const a={firstname:t,middlename:document.getElementById("edit-middlename").value.trim(),lastname:i,email:document.getElementById("edit-email").value.trim(),contact:document.getElementById("edit-contact").value.trim(),dob:document.getElementById("edit-dob").value,walkin_list:document.getElementById("edit-markup").value.trim()||"Walk-in",address:document.getElementById("edit-address").value.trim()||"N/A",status:"1"},n=document.getElementById("edit-client-original-id").value;if(!n){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-check-circle"></i> Continue to Insurance Form'),g=!1,Swal.fire({icon:"error",title:"Error",text:"Client ID not found!"});return}try{const c=document.querySelector('meta[name="csrf-token"]').content,r=await fetch(`/clients/${n}`,{method:"PUT",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":c,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(a)}),s=await r.json();if(!r.ok)throw new Error(s.message||"Failed to update client");console.log("Client updated successfully:",s);const o=s.data||s.client;if(o){const m=`${o.lastname}, ${o.firstname}${o.middlename?" "+o.middlename:""}`,y=$("#modal-client_id"),p=y.find(`option[value="${o.id}"]`);if(p.length>0)p.text(m);else{const v=new Option(m,o.id,!0,!0);y.append(v)}y.trigger("change")}const f=document.querySelector(".swal2-confirm");f&&(f.disabled=!1,f.style.opacity="1",f.style.cursor="pointer");const d=I,u=B;closeClientEditModal(),d&&u&&(h(4),N({mvfile_no:d.mvfile_no,coc_no:u.cocNumber,or_no:u.orNumber||u.cocNumber,policy_no:u.policyNumber||u.cocNumber},d.existingRecord||null,d.isCopy||!1,a))}catch(c){console.error("Error updating client:",c),Swal.fire({icon:"error",title:"Error",text:c.message||"Failed to update client. Please try again."}),e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-check-circle"></i> Continue to Insurance Form')}finally{g=!1}};let S=null,M=null;function J(e,t){const i=document.getElementById("createClientModal"),a=document.getElementById("createClientModalOverlay"),n=document.getElementById("createClientForm");!i||!n||(S=e,M=t,n.reset(),i.style.display="flex",a&&(a.style.display="block"))}window.closeCreateClientModal=function(){const e=document.getElementById("createClientModal"),t=document.getElementById("createClientModalOverlay");e&&(e.style.display="none"),t&&(t.style.display="none"),S=null,M=null};window.submitCreateClient=async function(){if(g)return;g=!0;const e=document.getElementById("createClientSubmitBtn");e&&(e.disabled=!0,e.innerHTML='<i class="fas fa-spinner fa-spin"></i> Creating...');const t=document.getElementById("create-firstname").value.trim(),i=document.getElementById("create-lastname").value.trim();if(!t){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Create Client'),Swal.fire({icon:"error",title:"Validation Error",text:"First name is required!"});return}if(!i){e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Create Client'),Swal.fire({icon:"error",title:"Validation Error",text:"Last name is required!"});return}const a={firstname:t,middlename:document.getElementById("create-middlename").value.trim(),lastname:i,email:document.getElementById("create-email").value.trim(),contact:document.getElementById("create-contact").value.trim(),dob:document.getElementById("create-dob").value,walkin_list:document.getElementById("create-markup").value.trim()||"Walk-in",address:document.getElementById("create-address").value.trim()||"N/A",status:"1"};Swal.fire({title:"Creating Client...",allowOutsideClick:!1,showConfirmButton:!1,didOpen:()=>{Swal.showLoading()}});try{const n=document.querySelector('meta[name="csrf-token"]').content,c=await fetch("/clients",{method:"POST",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":n,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(a)}),r=await c.json();if(!c.ok)throw new Error(r.message||"Failed to create client");const s=r.data,o=s.id,f=`${s.lastname}, ${s.firstname}${s.middlename?" "+s.middlename:""}`;console.log("Client created successfully:",o,f);const d=M,u=S;console.log("Stored results:",{localMvfileResult:d,localCocResult:u}),closeCreateClientModal(),Swal.close(),setTimeout(()=>{if(d&&u){console.log("Opening insurance form with new client:",o),h(4);const m=$("#modal-client_id"),y=new Option(f,o,!0,!0);m.append(y),N({mvfile_no:d.mvfile_no,coc_no:u.cocNumber,or_no:u.orNumber||u.cocNumber,policy_no:u.policyNumber||u.cocNumber},null,!1,null,o)}else console.error("Missing required data:",{localMvfileResult:d,localCocResult:u}),Swal.fire({icon:"error",title:"Error",text:"Failed to open insurance form. Missing required data."});g=!1},300)}catch(n){console.error("Error creating client:",n),Swal.fire({icon:"error",title:"Error",text:n.message||"Failed to create client. Please try again."})}finally{e&&(e.disabled=!1,e.innerHTML='<i class="fas fa-save"></i> Create Client'),g=!1}};async function N(e,t,i=!1,a=null,n=null){console.log("showManageInsuranceModal called with:",{formData:e,existingRecord:t,isCopy:i,editedClientData:a,newClientId:n});const c=document.getElementById("manageInsuranceModal"),r=document.getElementById("insuranceModalOverlay"),s=document.getElementById("insuranceForm"),o=document.getElementById("insuranceSubmitBtn"),f=document.getElementById("manageInsuranceModalTitle"),d=document.getElementById("officeSelectGroup");if(console.log("Modal elements found:",{modal:!!c,overlay:!!r,form:!!s,submitBtn:!!o,modalTitle:!!f}),!c||!s){console.error("Modal or form not found! Cannot open insurance form.");return}if(document.getElementById("insurance_id").value="",document.getElementById("insurance_form_method").value="POST",l("modal-mvfile_no",e.mvfile_no||""),l("modal-coc_no",e.coc_no||""),l("modal-or_no",e.or_no||""),l("modal-policy_no",e.policy_no||""),t)if(i){document.getElementById("insurance_id").value="",document.getElementById("insurance_form_method").value="POST",f.textContent="Copy Insurance Record to Your Office",o.innerHTML='<i class="fas fa-copy"></i> Create Copy in Your Office',l("modal-client_id","clone_"+t.client_id),l("modal-policy_id",t.policy_id||"");let u=document.getElementById("modal-clone_client_id");if(u||(u=document.createElement("input"),u.type="hidden",u.id="modal-clone_client_id",s.appendChild(u)),u.value=t.client_id,a){let m=document.getElementById("modal-edited_client_data");m||(m=document.createElement("input"),m.type="hidden",m.id="modal-edited_client_data",m.name="edited_client_data",s.appendChild(m)),m.value=JSON.stringify(a)}if(l("modal-category_id",t.auth_no||""),l("modal-code",""),l("modal-registration_no",t.registration_no||""),l("modal-chassis_no",t.chassis_no||""),l("modal-engine_no",t.engine_no||""),l("modal-vehicle_model",t.vehicle_model||""),l("modal-vehicle_color",t.vehicle_color||""),l("modal-make",t.make||""),l("modal-registration_date",""),l("modal-expiration_date",""),l("modal-cost",""),l("modal-status","0"),l("modal-remarks",t.insurance_remarks||t.remarks||""),setTimeout(()=>{const m=a?a.firstname+" "+(a.middlename?a.middlename+" ":"")+a.lastname+" (Edited - Will be cloned to your office)":t.firstname+" "+(t.middlename?t.middlename+" ":"")+t.lastname+" (Will be cloned to your office)",y=$("#modal-client_id"),p=new Option(m,"clone_"+t.client_id,!0,!0);y.append(p).trigger("change"),t.policy_id&&$("#modal-policy_id").val(t.policy_id).trigger("change"),t.auth_no&&$("#modal-category_id").val(t.auth_no).trigger("change")},100),d&&window.isSuperAdmin){d.style.display="block";const m=document.getElementById("modal-office_id");m&&(m.value="")}else d&&(d.style.display="none")}else document.getElementById("insurance_id").value=t.insurance_id||"",document.getElementById("insurance_form_method").value="PUT",l("modal-client_id",t.client_id||""),l("modal-policy_id",t.policy_id||""),l("modal-category_id",t.auth_no||""),l("modal-code",t.insurance_code||t.code||""),l("modal-registration_no",t.registration_no||""),l("modal-chassis_no",t.chassis_no||""),l("modal-engine_no",t.engine_no||""),l("modal-vehicle_model",t.vehicle_model||""),l("modal-vehicle_color",t.vehicle_color||""),l("modal-make",t.make||""),l("modal-registration_date",t.registration_date||""),l("modal-expiration_date",t.expiration_date||""),l("modal-cost",t.cost??""),l("modal-status",String(t.insurance_status??t.status??"0")),l("modal-remarks",t.insurance_remarks||t.remarks||""),f.textContent="Edit Insurance",o.innerHTML='<i class="fas fa-save"></i> Update',setTimeout(()=>{t.client_id&&$("#modal-client_id").val(t.client_id).trigger("change"),t.policy_id&&$("#modal-policy_id").val(t.policy_id).trigger("change"),t.auth_no&&$("#modal-category_id").val(t.auth_no).trigger("change")},100),d&&(d.style.display="none");else if(n?l("modal-client_id",n):l("modal-client_id",""),l("modal-policy_id",""),l("modal-category_id",""),l("modal-registration_no",""),l("modal-chassis_no",""),l("modal-engine_no",""),l("modal-vehicle_model",""),l("modal-vehicle_color",""),l("modal-make",""),l("modal-registration_date",""),l("modal-expiration_date",""),l("modal-cost",""),l("modal-status","0"),l("modal-remarks",""),f.textContent="New Insurance",o.innerHTML='<i class="fas fa-save"></i> Save',setTimeout(()=>{n?$("#modal-client_id").val(n).trigger("change"):$("#modal-client_id").val("").trigger("change"),$("#modal-policy_id").val("").trigger("change"),$("#modal-category_id").val("").trigger("change")},100),d&&window.isSuperAdmin){d.style.display="block";const u=document.getElementById("modal-office_id");u&&(u.value="")}else d&&(d.style.display="none");c.style.setProperty("display","flex","important"),c.style.setProperty("visibility","visible","important"),c.style.setProperty("opacity","1","important"),c.style.setProperty("z-index","9999","important"),r&&(r.style.setProperty("display","block","important"),r.style.setProperty("visibility","visible","important"),r.style.setProperty("opacity","1","important"),r.style.setProperty("z-index","9998","important")),console.log("Modal display styles set:",{modalDisplay:c.style.display,modalVisibility:c.style.visibility,modalOpacity:c.style.opacity,modalZIndex:c.style.zIndex}),setTimeout(()=>{$(".js-example-basic-single").select2({width:"100%",dropdownParent:$("#manageInsuranceModal")}),(c.style.display==="none"||window.getComputedStyle(c).display==="none")&&(console.warn("Modal was hidden after Select2 init, forcing visible again"),c.style.setProperty("display","flex","important"))},200)}function l(e,t){const i=document.getElementById(e);if(!i)return;const a=t==null?"":String(t);i.classList.contains("js-example-basic-single"),i.value=a}window.closeInsuranceModal=function(){const e=document.getElementById("manageInsuranceModal"),t=document.getElementById("insuranceModalOverlay");e&&(e.style.display="none"),t&&(t.style.display="none")};async function G(e){var u;e.preventDefault();const t=document.getElementById("insuranceForm"),i=document.getElementById("insuranceSubmitBtn");if(!t)return;const a=document.getElementById("insurance_id").value,n=!!a,c=new FormData(t),r={};c.forEach((m,y)=>{y==="_token"||y==="_method"||y==="insurance_id"||(r[y]=m)});const s=document.getElementById("modal-edited_client_data");if(s&&s.value)try{r.edited_client_data=JSON.parse(s.value)}catch(m){console.error("Error parsing edited client data:",m)}if(!n&&window.isSuperAdmin){const m=(u=document.getElementById("modal-office_id"))==null?void 0:u.value;m&&(r.office_id=m)}const o=n?`${insuranceUpdateUrl}/${a}`:insuranceStoreUrl,f=n?"PUT":"POST",d=document.querySelector('meta[name="csrf-token"]').content;i&&(i.disabled=!0,i.innerHTML='<i class="fas fa-spinner fa-spin"></i> '+(n?"Updating...":"Saving..."));try{const m={method:f,headers:{"Content-Type":"application/json","X-CSRF-TOKEN":d,Accept:"application/json","X-Requested-With":"XMLHttpRequest"},body:JSON.stringify(r)};f==="PUT"&&(m.headers["X-HTTP-Method-Override"]="PUT");const y=await fetch(o,m),p=await y.json().catch(()=>({}));if(!y.ok){if(y.status===422&&p&&p.message)throw closeInsuranceModal(),new Error(p.message);const w=p&&typeof p=="object"&&p.errors&&typeof p.errors=="object"?Object.values(p.errors).flat().filter(Boolean).join(" "):p&&typeof p=="object"&&p.message||"Request failed";throw new Error(w)}b(),C();let v=a;!v&&p&&p.insurance&&p.insurance.id&&(v=p.insurance.id),closeInsuranceModal(),Swal.fire({title:"Success!",text:n?"Insurance record updated successfully!":"Insurance record added successfully!",icon:"success",timer:2e3,showConfirmButton:!1}).then(()=>{v&&(window.location.href=`/insurances/${v}`)})}catch(m){typeof Swal<"u"?Swal.fire({icon:"error",title:"Error",text:m.message||"Something went wrong."}):alert(m.message||"Something went wrong.")}finally{i&&(i.disabled=!1,i.innerHTML=n?'<i class="fas fa-save"></i> Update':'<i class="fas fa-save"></i> Save'),g=!1}}function W(e){window.location.href=`/insurances/${e}`}function K(){Swal.fire({title:"Load Data",input:"select",inputOptions:{10:"Load 10 Records",50:"Load 50 Records",100:"Load 100 Records",500:"Load 500 Records"},inputPlaceholder:"Select batch size",showCancelButton:!0,confirmButtonText:"Load",customClass:{popup:"modern-swal-popup",confirmButton:"modern-confirm-btn",cancelButton:"modern-cancel-btn"}}).then(e=>{e.isConfirmed&&z(e.value)})}function z(e){Swal.fire({title:"Loading Data...",html:'<div style="width: 100%; background: #f3f3f3; border-radius: 25px; overflow: hidden;"><div id="data-progress" style="width: 0%; height: 20px; background: linear-gradient(90deg, #1877f2, #7209b7);"></div></div>',allowOutsideClick:!1,showConfirmButton:!1,didOpen:()=>{let t=0;const i=setInterval(()=>{t+=5;const a=document.getElementById("data-progress");a&&(a.style.width=t+"%"),t>=100&&clearInterval(i)},100);setTimeout(()=>{b(),Swal.close(),T("Success","Data loaded successfully","success")},2e3)}})}function h(e){document.querySelectorAll(".flow-step").forEach(t=>{t.classList.remove("active"),parseInt(t.getAttribute("data-step"))<=e&&t.classList.add("active")})}function T(e,t,i){Swal.fire({title:e,text:t,icon:i,customClass:{popup:"modern-swal-popup",confirmButton:"modern-confirm-btn"}})}window.viewInsuranceDetails=function(e){window.location.href=`/insurances/${e}`};window.editInsuranceDetails=function(e){Y(e)};function Y(e){const t=document.getElementById("manageInsuranceModal"),i=document.getElementById("insuranceModalOverlay"),a=document.getElementById("insuranceForm"),n=document.getElementById("insuranceSubmitBtn"),c=document.getElementById("manageInsuranceModalTitle"),r=document.getElementById("officeSelectGroup");!t||!a||(n.disabled=!0,n.innerHTML='<i class="fas fa-spinner fa-spin"></i> Loading...',fetch(`${manageInsuranceUrl}?id=${e}`).then(s=>s.json()).then(s=>{if(!s.insurance)throw new Error("Insurance not found");const o=s.insurance;document.getElementById("insurance_id").value=o.id,document.getElementById("insurance_form_method").value="PUT",l("modal-mvfile_no",o.mvfile_no||""),l("modal-coc_no",o.coc_no||""),l("modal-or_no",o.or_no||""),l("modal-policy_no",o.policy_no||""),l("modal-registration_no",o.registration_no||""),l("modal-chassis_no",o.chassis_no||""),l("modal-engine_no",o.engine_no||""),l("modal-vehicle_model",o.vehicle_model||""),l("modal-vehicle_color",o.vehicle_color||""),l("modal-make",o.make||""),l("modal-registration_date",o.registration_date||""),l("modal-expiration_date",o.expiration_date||""),l("modal-cost",o.cost||""),l("modal-status",String(o.status||"0")),l("modal-remarks",o.remarks||""),c.textContent="Edit Insurance",n.innerHTML='<i class="fas fa-save"></i> Update',n.disabled=!1,n.onclick=null,a.querySelectorAll(".form-control").forEach(d=>{d.removeAttribute("readonly"),d.removeAttribute("disabled")}),r&&(r.style.display="none"),t.style.display="flex",i&&(i.style.display="block"),setTimeout(()=>{o.client_id&&$("#modal-client_id").val(o.client_id).trigger("change"),o.policy_id&&$("#modal-policy_id").val(o.policy_id).trigger("change"),o.auth_no&&$("#modal-category_id").val(o.auth_no).trigger("change"),$(".js-example-basic-single").select2({width:"100%",dropdownParent:$("#manageInsuranceModal")})},100)}).catch(s=>{console.error("Error loading insurance:",s),T("Error","Failed to load insurance details","error"),n.disabled=!1,n.innerHTML='<i class="fas fa-save"></i> Save'}))}window.deleteInsurance=function(e){Swal.fire({title:"Are you sure?",text:"You won't be able to revert this!",icon:"warning",showCancelButton:!0,confirmButtonColor:"#d33",cancelButtonColor:"#3085d6",confirmButtonText:"Yes, delete it!"}).then(t=>{if(t.isConfirmed){const i=document.querySelector('meta[name="csrf-token"]').content,a=`${insuranceUpdateUrl}/${e}`;fetch(a,{method:"DELETE",headers:{"Content-Type":"application/json","X-CSRF-TOKEN":i,"X-Requested-With":"XMLHttpRequest"}}).then(n=>n.json()).then(n=>{n.success?(b(),C(),Swal.fire("Deleted!","Insurance record has been deleted.","success")):Swal.fire("Error!",n.message||"Failed to delete insurance record.","error")}).catch(n=>{console.error("Error deleting insurance:",n),Swal.fire("Error!","An error occurred while deleting the record.","error")})}})};function Z(){$(".js-example-basic-single").each(function(){var e=$(this),t=e.siblings("label");e.val()?t.addClass("active"):t.removeClass("active")})}$(document).ready(function(){$(".js-example-basic-single").on("change",function(){Z()})});function Q(e){const t=document.getElementById("mvfileNotification");if(!t)return;t.dataset.record=JSON.stringify(e),t.classList.remove("hidden"),t.style.display="block";const i=document.querySelector(".swal2-confirm");i&&(i.disabled=!0,i.style.opacity="0.5",i.style.cursor="not-allowed")}function E(){const e=document.getElementById("mvfileNotification");e&&(e.classList.add("hidden"),setTimeout(()=>{e.style.display="none"},300))}window.skipClientEdit=function(){E();const e=document.querySelector(".swal2-confirm");e&&(e.disabled=!1,e.style.opacity="1",e.style.cursor="pointer")};window.transferClientEdit=function(){const e=document.getElementById("mvfileNotification");if(!e)return;const t=e.dataset.record;if(t)try{const i=JSON.parse(t);E(),O(i,null,{mvfile_no:i.mvfile_no,existingRecord:i,isCopy:!1})}catch(i){console.error("Error parsing record data:",i)}};window.closeInsuranceModal=window.closeInsuranceModal||closeInsuranceModal;window.closeClientEditModal=window.closeClientEditModal||closeClientEditModal;window.closeCreateClientModal=window.closeCreateClientModal||closeCreateClientModal;window.submitClientEdit=window.submitClientEdit||submitClientEdit;window.submitCreateClient=window.submitCreateClient||submitCreateClient;window.deleteInsurance=window.deleteInsurance||deleteInsurance;window.viewInsuranceDetails=window.viewInsuranceDetails||W;window.editInsuranceDetails=window.editInsuranceDetails||editInsuranceDetails;window.skipClientEdit=window.skipClientEdit||skipClientEdit;window.transferClientEdit=window.transferClientEdit||transferClientEdit;
